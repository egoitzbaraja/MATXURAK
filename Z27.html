<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Gestión de Reparaciones de Chromebooks</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .modal-backdrop {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            max-height: 90vh;
            overflow-y: auto;
            width: 11/12; /* Default for mobile */
            max-width: 900px; /* Max width for larger screens */
        }
        @media (min-width: 768px) {
            .modal-content {
                width: 2/3; /* Adjust for tablet */
            }
        }
        @media (min-width: 1024px) {
            .modal-content {
                width: 1/2; /* Adjust for desktop */
            }
        }
        .photo-preview-container {
            width: 100%;
            height: 200px; /* Fixed height for preview */
            background-color: #f0f0f0;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            border: 2px dashed #cbd5e1; /* Default dashed border */
            transition: border-color: 0.3s ease;
        }
        .photo-preview-container.drag-over {
            border-color: #3B82F6; /* Blue border on drag over */
        }
        .photo-preview-container img, .photo-preview-container video {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        .photo-thumbnails-container {
            display: flex;
            gap: 0.5rem;
            overflow-x: auto;
            padding-bottom: 0.5rem;
        }
        .thumbnail-wrapper {
            position: relative;
            flex-shrink: 0;
        }
        .thumbnail-img {
            width: 64px;
            height: 64px;
            object-fit: cover;
            border-radius: 0.375rem;
            cursor: pointer;
            border: 2px solid transparent;
        }
        .thumbnail-img.selected {
            border-color: #3B82F6;
        }
        .thumbnail-delete-btn {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: rgba(239, 68, 68, 0.9);
            color: white;
            border-radius: 9999px;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            line-height: 1;
            cursor: pointer;
            border: 1px solid white;
        }
        .sortable-th {
            cursor: pointer;
            user-select: none;
        }
        .sort-icon {
            margin-left: 0.5rem;
            display: inline-block;
            width: 0;
            height: 0;
            vertical-align: middle;
        }
        .sort-icon.asc {
            border-left: 4px solid transparent;
            border-right: 4px solid transparent;
            border-bottom: 4px solid currentColor;
        }
        .sort-icon.desc {
            border-left: 4px solid transparent;
            border-right: 4px solid transparent;
            border-top: 4px solid currentColor;
        }
        /* Tabs styling */
        .tab-button {
            padding: 0.75rem 1.25rem;
            border-bottom: 2px solid transparent;
            font-weight: 500;
            color: #6B7280; /* gray-500 */
            transition: all 0.2s ease-in-out;
        }
        .tab-button.active {
            border-color: #3B82F6; /* blue-500 */
            color: #1F2937; /* gray-900 */
            font-weight: 600;
        }
        .tab-button:hover:not(.active) {
            color: #3B82F6; /* blue-500 */
        }
        .tab-content {
            display: none;
            padding-top: 1rem;
        }
        .tab-content.active {
            display: block;
        }
        /* Autocomplete suggestions */
        .autocomplete-suggestion {
            padding: 0.5rem 1rem;
            cursor: pointer;
            border-bottom: 1px solid #F3F4F6; /* stone-100 */
        }
        .autocomplete-suggestion:hover {
            background-color: #F3F4F6; /* stone-100 */
        }
        .autocomplete-suggestion:last-child {
            border-bottom: none;
        }
        /* Drag and Drop styles for Class Groups */
        .class-group-row.dragging {
            opacity: 0.5;
        }
        .class-group-row.drag-over {
            border-top: 2px solid #3B82F6; /* blue-500 */
        }
        /* Estilos para la sección de préstamo en la ficha de avería */
        .loaner-section {
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .loaner-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }
        .loaner-status-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        .loaner-status-badge.available {
            background-color: #dcfce7;
            color: #166534;
        }
        .loaner-status-badge.assigned {
            background-color: #fef3c7;
            color: #92400e;
        }
        .loaner-status-badge.maintenance {
            background-color: #f1f5f9;
            color: #475569;
        }
        /* Clase .hidden que faltaba */
        .hidden {
            display: none !important;
        }
        /* Estilos para el selector de idioma en el encabezado */
        .language-selector {
            position: relative;
        }
        .language-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 50;
            min-width: 150px;
            display: none;
        }
        .language-dropdown.show {
            display: block;
        }
        .language-option {
            padding: 0.5rem 1rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .language-option:hover {
            background-color: #f3f4f6;
        }
        .language-option.active {
            background-color: #eff6ff;
            font-weight: 600;
        }
        
        /* Estilos para la edición de clases */
        .class-name-input {
            transition: all 0.2s ease;
        }
        
        .class-name-input:focus {
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 4px;
            padding-left: 4px;
            padding-right: 4px;
        }
        
        .drag-handle {
            cursor: move;
            color: #9CA3AF;
            font-size: 16px;
            padding: 2px;
        }
        
        .class-group-row.dragging {
            opacity: 0.5;
        }
        
        .class-group-row.drag-over {
            border-top: 2px solid #3B82F6;
            margin-top: 4px;
        }
        
        /* Estilos para la sección de estadísticas */
        .stats-card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            padding: 1.5rem;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        .stats-card h3 {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: #1f2937;
        }
        .chart-container {
            flex-grow: 1;
            position: relative;
            min-height: 250px;
        }
        
        /* Estilos para el selector de curso escolar */
        .school-year-selector {
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .school-year-selector label {
            font-weight: 600;
            color: #4b5563;
        }
        
        .school-year-selector select {
            background-color: #f9fafb;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            padding: 0.5rem;
            font-size: 0.875rem;
            color: #1f2937;
            min-width: 150px;
        }
        
        /* Estilos para la gestión de cursos académicos */
        .school-year-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            background-color: #f9fafb;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
        }
        
        .school-year-item-info {
            flex-grow: 1;
        }
        
        .school-year-item-name {
            font-weight: 600;
            color: #1f2937;
        }
        
        .school-year-item-dates {
            font-size: 0.875rem;
            color: #6b7280;
        }
        
        .school-year-item-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .btn-small {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            border-radius: 0.25rem;
        }
        
        /* Estilos para la paginación */
        .pagination-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1rem;
        }
        
        .pagination-info {
            font-size: 0.875rem;
            color: #6b7280;
        }
        
        .pagination-controls {
            display: flex;
            gap: 0.5rem;
        }
        
        .pagination-btn {
            padding: 0.375rem 0.75rem;
            font-size: 0.875rem;
            border-radius: 0.375rem;
            background-color: #f3f4f6;
            color: #4b5563;
            border: 1px solid #d1d5db;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .pagination-btn:hover:not(:disabled) {
            background-color: #e5e7eb;
        }
        
        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .pagination-btn.active {
            background-color: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }
        
        .page-size-selector {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .page-size-selector select {
            background-color: #f9fafb;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            padding: 0.375rem 0.75rem;
            font-size: 0.875rem;
            color: #4b5563;
        }
    </style>
</head>
<body class="bg-stone-100 text-slate-800">
    <div class="container mx-auto p-4 md:p-8">
        
        <header class="mb-8 flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <img id="app-logo-header" src="" alt="Logo de la Aplicación" class="h-12 w-12 object-contain hidden">
                <div>
                    <h1 id="app-name-header" class="text-3xl font-bold text-slate-900"></h1>
                    <p id="app-description-header" class="text-slate-600 mt-1"></p>
                </div>
            </div>
            <div class="flex items-center space-x-4">
                <!-- Selector de idioma en el encabezado -->
                <div class="language-selector">
                    <button id="header-language-btn" class="bg-gray-200 text-gray-800 font-bold py-2.5 px-4 rounded-lg hover:bg-gray-300 transition-colors inline-flex items-center justify-center min-w-fit min-h-fit">
                        <span id="current-language-flag">🇪🇸</span>
                        <span id="current-language-text" class="ml-2">Español</span>
                        <svg class="ml-2 w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                    <div id="header-language-dropdown" class="language-dropdown">
                        <div class="language-option active" data-lang="es">
                            <span class="mr-2">🇪🇸</span> Español
                        </div>
                        <div class="language-option" data-lang="eus">
                            <span class="mr-2">🇪🇺</span> Euskara
                        </div>
                    </div>
                </div>
                <button id="reports-btn" class="bg-blue-600 text-white font-bold py-2.5 px-4 rounded-lg hover:bg-blue-700 transition-colors inline-flex items-center justify-center min-w-fit min-h-fit"></button>
                <button id="config-btn" class="bg-gray-200 text-gray-800 font-bold py-2.5 px-4 rounded-lg hover:bg-gray-300 transition-colors inline-flex items-center justify-center min-w-fit min-h-fit">⚙️</button>
            </div>
        </header>
        <main>
            <!-- Sección de KPIs -->
            <section id="kpi-section" class="mb-8">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="bg-white p-5 rounded-xl shadow-sm flex items-center space-x-4">
                        <div class="bg-blue-100 text-blue-600 p-3 rounded-full">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg>
                        </div>
                        <div>
                            <p id="kpi-total-chromebooks-label" class="text-sm text-slate-500"></p>
                            <p id="total-chromebooks" class="text-2xl font-bold">0</p>
                        </div>
                    </div>
                    <div class="bg-white p-5 rounded-xl shadow-sm flex items-center space-x-4">
                        <div class="bg-orange-100 text-orange-600 p-3 rounded-full">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                        </div>
                        <div>
                            <p id="kpi-in-progress-repairs-label" class="text-sm text-slate-500"></p>
                            <p id="in-progress-repairs" class="text-2xl font-bold">0</p>
                        </div>
                    </div>
                    <div class="bg-white p-5 rounded-xl shadow-sm flex items-center space-x-4">
                        <div class="bg-green-100 text-green-600 p-3 rounded-full">
                           <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                        </div>
                        <div>
                            <p id="kpi-repaired-month-label" class="text-sm text-slate-500"></p>
                            <p id="repaired-month" class="text-2xl font-bold">0</p>
                        </div>
                    </div>
                    <div class="bg-white p-5 rounded-xl shadow-sm flex items-center space-x-4">
                        <div class="bg-purple-100 text-purple-600 p-3 rounded-full">
                           <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 14v3m4-3v3m4-3v3M3 21h18M3 10h18M3 7l9-4 9 4M4 10h16v11H4V10z" /></svg>
                        </div>
                        <div>
                            <p id="kpi-available-loaners-label" class="text-sm text-slate-500"></p>
                            <p id="available-loaners" class="text-2xl font-bold">0</p>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- Sección de Estadísticas -->
            <section id="stats-section" class="mb-8">
                <div class="flex justify-between items-center mb-4">
                    <h2 id="stats-title" class="text-2xl font-bold"></h2>
                    
                    <!-- Selector de curso escolar -->
                    <div class="school-year-selector">
                        <label for="school-year-select" id="label-school-year">Curso escolar:</label>
                        <select id="school-year-select" class="bg-stone-100 border border-stone-200 text-slate-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                            <!-- Options populated by JS -->
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="stats-card">
                        <h3 id="monthly-stats-title" class="font-medium mb-2"></h3>
                        <div class="chart-container">
                            <canvas id="monthly-chart"></canvas>
                        </div>
                    </div>
                    <div class="stats-card">
                        <h3 id="class-stats-title" class="font-medium mb-2"></h3>
                        <div class="chart-container">
                            <canvas id="class-chart"></canvas>
                        </div>
                    </div>
                    <div class="stats-card">
                        <h3 id="student-stats-title" class="font-medium mb-2"></h3>
                        <div class="chart-container">
                            <canvas id="students-chart"></canvas>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- Tabla de Averías (ahora de ancho completo) -->
            <div class="bg-white p-6 rounded-xl shadow-sm mb-8">
                <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                    <h3 id="repairs-list-title" class="font-bold text-lg"></h3>
                    <div class="flex items-center gap-2 w-full md:w-auto">
                         <select id="status-filter" class="w-full md:w-auto bg-stone-100 border border-stone-200 text-slate-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                            <!-- Options populated by JS -->
                        </select>
                        <input type="text" id="search-input" class="w-full md:w-auto bg-stone-100 border border-stone-200 text-slate-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                        <button id="add-repair-btn" class="bg-blue-600 text-white font-bold py-2.5 px-4 rounded-lg hover:bg-blue-700 transition-colors inline-flex items-center justify-center min-w-fit min-h-fit flex-shrink-0"></button>
                        <button id="delete-selected-repairs-btn" class="bg-red-600 text-white font-bold py-2.5 px-4 rounded-lg hover:bg-red-700 transition-colors hidden inline-flex items-center justify-center min-w-fit min-h-fit flex-shrink-0"></button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-slate-500">
                        <thead class="text-xs text-slate-700 uppercase bg-stone-50">
                            <tr>
                                <th scope="col" class="p-4">
                                    <div class="flex items-center">
                                        <input id="select-all-repairs" type="checkbox" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500">
                                        <label for="select-all-repairs" class="sr-only">checkbox</label>
                                    </div>
                                </th>
                                <th scope="col" class="px-6 py-3 sortable-th" data-sort="id">
                                    <span>ID</span>
                                    <span class="sort-icon"></span>
                                </th>
                                <th scope="col" class="px-6 py-3 sortable-th" data-sort="studentName">
                                    <span id="table-header-student"></span>
                                    <span class="sort-icon"></span>
                                </th>
                                <th scope="col" class="px-6 py-3 sortable-th" data-sort="className">
                                    <span id="table-header-class"></span>
                                    <span class="sort-icon"></span>
                                </th>
                                <th scope="col" class="px-6 py-3 sortable-th" data-sort="serialNumber">
                                    <span id="table-header-serial-number">Nº Serie</span>
                                    <span class="sort-icon"></span>
                                </th>
                                <th scope="col" class="px-6 py-3 sortable-th" data-sort="status">
                                    <span id="table-header-status"></span>
                                    <span class="sort-icon"></span>
                                </th>
                                <th scope="col" class="px-6 py-3 sortable-th" data-sort="reportedDate">
                                    <span id="table-header-reported-date"></span>
                                    <span class="sort-icon"></span>
                                </th>
                                <th scope="col" class="px-6 py-3 sortable-th" data-sort="repairedDate">
                                    <span id="table-header-repaired-date"></span>
                                    <span class="sort-icon"></span>
                                </th>
                                <th scope="col" class="px-6 py-3" id="table-header-actions"></th>
                            </tr>
                        </thead>
                        <tbody id="repairs-table-body">
                            <!-- Rows populated by JS -->
                        </tbody>
                    </table>
                    <p id="no-results-p" class="text-center p-4 text-slate-500 hidden"></p>
                </div>
                
                <!-- Controles de paginación -->
                <div class="pagination-container">
                    <div class="pagination-info">
                        <span id="pagination-info-text">Mostrando 1-10 de 25 resultados</span>
                    </div>
                    <div class="pagination-controls" id="pagination-controls">
                        <!-- Botones de paginación generados por JS -->
                    </div>
                    <div class="page-size-selector">
                        <label for="page-size-select" class="text-sm text-slate-700">Mostrar:</label>
                        <select id="page-size-select" class="bg-stone-100 border border-stone-200 text-slate-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2">
                            <option value="10">10</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                        </select>
                    </div>
                </div>
            </div>
            <!-- Gráfico y Gestión de Préstamos (lado a lado) -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-sm">
                    <h3 id="status-chart-title" class="font-bold text-lg mb-4"></h3>
                    <div class="relative h-72">
                        <canvas id="repairs-chart"></canvas>
                    </div>
                </div>
                <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-sm">
                    <div class="flex justify-between items-center mb-4">
                        <h3 id="loaner-management-title" class="font-bold text-lg"></h3>
                        <button id="add-loaner-btn" class="bg-purple-600 text-white font-bold py-2.5 px-4 rounded-lg hover:bg-purple-700 transition-colors inline-flex items-center justify-center min-w-fit min-h-fit"></button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-slate-500">
                            <thead class="text-xs text-slate-700 uppercase bg-stone-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3" id="loaner-table-header-id"></th>
                                    <th scope="col" class="px-6 py-3" id="loaner-table-header-status"></th>
                                    <th scope="col" class="px-6 py-3" id="loaner-table-header-assigned-to">Asignado a</th>
                                    <th scope="col" class="px-6 py-3" id="loaner-table-header-actions"></th>
                                </tr>
                            </thead>
                            <tbody id="loaner-table-body">
                                <!-- Loaner rows populated by JS -->
                            </tbody>
                        </table>
                        <p id="no-loaner-results-p" class="text-center p-4 text-slate-500 hidden"></p>
                    </div>
                </div>
            </div>
        </main>
    </div>
    <!-- Add/Edit Repair Modal -->
    <div id="repair-modal" class="modal-backdrop">
        <div class="modal-content bg-white rounded-xl shadow-xl p-8 m-4 relative">
            <button id="close-modal-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <h3 id="modal-title" class="text-2xl font-bold mb-6"></h3>
            <form id="repair-form">
                <input type="hidden" id="repair-id">
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div class="relative">
                        <label for="repair-student-name" id="label-repair-student-name" class="block mb-2 text-sm font-medium text-slate-900"></label>
                        <input type="text" id="repair-student-name" class="bg-stone-50 border border-stone-300 text-slate-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                        <div id="student-name-suggestions" class="absolute z-10 w-full bg-white border border-stone-300 rounded-lg mt-1 max-h-40 overflow-y-auto shadow-lg hidden"></div>
                    </div>
                    <div>
                        <label for="repair-class-name" id="label-repair-class-name" class="block mb-2 text-sm font-medium text-slate-900"></label>
                        <select id="repair-class-name" class="bg-stone-50 border border-stone-300 text-slate-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                            <!-- Options populated by JS -->
                        </select>
                    </div>
                </div>
                
                <!-- Campo para el número de serie del Chromebook -->
                <div class="mb-4">
                    <label for="repair-serial-number" id="label-repair-serial-number" class="block mb-2 text-sm font-medium text-slate-900">Número de Serie del Chromebook</label>
                    <input type="text" id="repair-serial-number" class="bg-stone-50 border border-stone-300 text-slate-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" placeholder="Ej: ABC123XYZ456">
                </div>
                
                <div class="mb-4">
                    <label for="repair-description" id="label-repair-description" class="block mb-2 text-sm font-medium text-slate-900"></label>
                    <textarea id="repair-description" rows="4" class="block p-2.5 w-full text-sm text-slate-900 bg-stone-50 rounded-lg border border-stone-300 focus:ring-blue-500 focus:border-blue-500" required></textarea>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="repair-status" id="label-repair-status" class="block mb-2 text-sm font-medium text-slate-900"></label>
                        <select id="repair-status" class="bg-stone-50 border border-stone-300 text-slate-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                           <!-- Options populated by JS -->
                        </select>
                    </div>
                    <div>
                        <label for="repair-reported-date" id="label-repair-reported-date" class="block mb-2 text-sm font-medium text-slate-900"></label>
                        <input type="date" id="repair-reported-date" class="bg-stone-50 border border-stone-300 text-slate-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                    </div>
                </div>
                <div class="mb-4">
                    <label for="repair-notes" id="label-repair-notes" class="block mb-2 text-sm font-medium text-slate-900"></label>
                    <textarea id="repair-notes" rows="3" class="block p-2.5 w-full text-sm text-slate-900 bg-stone-50 rounded-lg border border-stone-300 focus:ring-blue-500 focus:border-blue-500"></textarea>
                    <div id="notes-history" class="mt-2 text-xs text-slate-500 space-y-1"></div>
                </div>
                
                <!-- Sección de préstamo de Chromebook -->
                <div class="loaner-section mb-6">
                    <div class="loaner-header">
                        <h4 id="label-loaner-section" class="text-lg font-medium text-slate-900"></h4>
                        <div id="loaner-status-badge" class="loaner-status-badge"></div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="loaner-select" id="label-loaner-select" class="block mb-2 text-sm font-medium text-slate-900"></label>
                            <select id="loaner-select" class="bg-stone-50 border border-stone-300 text-slate-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                                <option value="">-- Seleccionar Chromebook de préstamo --</option>
                            </select>
                        </div>
                        <div>
                            <label for="loaner-return-date" id="label-loaner-return-date" class="block mb-2 text-sm font-medium text-slate-900"></label>
                            <input type="date" id="loaner-return-date" class="bg-stone-50 border border-stone-300 text-slate-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                        </div>
                    </div>
                    <div class="mt-3 flex justify-end">
                        <button type="button" id="assign-loaner-btn" class="bg-purple-600 text-white font-medium rounded-lg text-sm px-4 py-2 text-center hover:bg-purple-700 transition-colors"></button>
                        <button type="button" id="unassign-loaner-btn" class="bg-gray-200 text-gray-800 font-medium rounded-lg text-sm px-4 py-2 text-center hover:bg-gray-300 transition-colors ml-2 hidden"></button>
                    </div>
                </div>
                
                <div class="mb-6">
                    <h4 id="label-photo-section" class="block mb-2 text-sm font-medium text-slate-900"></h4>
                    <div class="photo-preview-container" id="photo-preview-container-main">
                        <img id="main-photo-preview" src="#" alt="Vista previa de la foto" class="hidden"/>
                        <video id="camera-feed" autoplay playsinline class="hidden"></video>
                        <span id="photo-placeholder" class="text-slate-400"></span>
                    </div>
                    <div id="photo-thumbnails-container" class="photo-thumbnails-container">
                        <!-- Thumbnails will be generated here -->
                    </div>
                    <div class="mt-2 flex items-center justify-center space-x-2">
                        <input type="file" id="photo-upload" accept="image/*" class="hidden" multiple>
                        <button type="button" id="upload-photo-btn" class="text-sm bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg"></button>
                        <button type="button" id="capture-photo-btn" class="text-sm bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg"></button>
                        <button type="button" id="take-picture-btn" class="text-sm bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg hidden"></button>
                    </div>
                </div>
                
                <div class="flex items-center mb-6">
                    <input id="has-cost-checkbox" type="checkbox" value="" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500">
                    <label for="has-cost-checkbox" id="label-has-cost" class="ml-2 text-sm font-medium text-gray-900"></label>
                </div>
                <div id="cost-amount-section" class="mb-4 hidden">
                    <label for="cost-amount" id="label-cost-amount" class="block mb-2 text-sm font-medium text-slate-900"></label>
                    <input type="number" id="cost-amount" step="0.01" class="bg-stone-50 border border-stone-300 text-slate-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                </div>
                <div class="flex justify-end">
                    <button type="submit" id="save-repair-btn" class="text-white bg-blue-600 hover:bg-blue-700 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm w-full sm:w-auto px-5 py-2.5 text-center"></button>
                </div>
            </form>
        </div>
    </div>
    <!-- Config Modal -->
    <div id="config-modal" class="modal-backdrop">
        <div class="modal-content bg-white rounded-xl shadow-xl p-8 m-4 relative">
            <button id="close-config-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <h3 id="config-modal-title" class="text-2xl font-bold mb-6"></h3>
            
            <div id="tabs" class="border-b border-gray-200">
                <nav class="-mb-px flex space-x-4" aria-label="Tabs">
                    <button class="tab-button active" data-tab="general-settings"></button>
                    <button class="tab-button" data-tab="class-management"></button>
                    <button class="tab-button" data-tab="school-year-management"></button>
                    <button class="tab-button" data-tab="data-management"></button>
                    <button class="tab-button" data-tab="pdf-settings"></button>
                </nav>
            </div>
            <div id="general-settings" class="tab-content active">
                <form id="config-form" class="mt-4 space-y-4">
                    <div>
                        <label for="app-name" id="label-app-name" class="block mb-2 text-sm font-medium text-slate-900"></label>
                        <input type="text" id="app-name" class="bg-stone-50 border border-stone-300 text-slate-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                    </div>
                    <div>
                        <label for="app-description" id="label-app-description" class="block mb-2 text-sm font-medium text-slate-900"></label>
                        <input type="text" id="app-description" class="bg-stone-50 border border-stone-300 text-slate-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                    </div>
                    <div>
                        <label for="app-logo" id="label-app-logo" class="block mb-2 text-sm font-medium text-slate-900"></label>
                        <input type="file" id="app-logo" accept="image/*" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                        <img id="logo-preview" src="#" alt="Vista previa del logo" class="mt-2 h-16 w-16 object-contain hidden rounded-md"/>
                    </div>
                    <div>
                        <label for="language-selector" id="label-language-selector" class="block mb-2 text-sm font-medium text-slate-900"></label>
                        <select id="language-selector" class="bg-stone-50 border border-stone-300 text-slate-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                            <option value="es">Español</option>
                            <option value="eus">Euskara</option>
                        </select>
                    </div>
                     <div>
                        <label for="contact-email" id="label-contact-email" class="block mb-2 text-sm font-medium text-slate-900"></label>
                        <input type="email" id="contact-email" class="bg-stone-50 border border-stone-300 text-slate-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                    </div>
                    <div class="flex justify-end pt-4">
                        <button type="submit" id="save-config-btn" class="text-white bg-blue-600 hover:bg-blue-700 font-medium rounded-lg text-sm px-5 py-2.5 text-center"></button>
                    </div>
                </form>
            </div>
            <div id="class-management" class="tab-content">
                <form id="add-class-group-form" class="mt-4 flex items-center gap-2 mb-4">
                    <input type="text" id="new-class-group-input" class="bg-stone-50 border border-stone-300 text-slate-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                    <button type="submit" id="add-class-group-btn" class="text-white bg-blue-600 hover:bg-blue-700 font-medium rounded-lg text-sm px-5 py-2.5 text-center flex-shrink-0"></button>
                </form>
                <div id="class-groups-list" class="space-y-2">
                    <!-- Class groups will be rendered here -->
                </div>
            </div>
            <div id="school-year-management" class="tab-content">
                <h4 class="font-medium text-slate-900 mb-4">Gestión de Cursos Académicos</h4>
                <form id="add-school-year-form" class="mb-4">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div>
                            <label for="school-year-name" class="block mb-2 text-sm font-medium text-slate-900">Nombre del Curso</label>
                            <input type="text" id="school-year-name" class="bg-stone-50 border border-stone-300 text-slate-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" placeholder="Ej: 2023-2024" required>
                        </div>
                        <div>
                            <label for="school-year-start-date" class="block mb-2 text-sm font-medium text-slate-900">Fecha de Inicio</label>
                            <input type="date" id="school-year-start-date" class="bg-stone-50 border border-stone-300 text-slate-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                        </div>
                        <div>
                            <label for="school-year-end-date" class="block mb-2 text-sm font-medium text-slate-900">Fecha de Fin</label>
                            <input type="date" id="school-year-end-date" class="bg-stone-50 border border-stone-300 text-slate-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                        </div>
                        <div class="flex items-end">
                            <button type="submit" class="text-white bg-blue-600 hover:bg-blue-700 font-medium rounded-lg text-sm px-5 py-2.5 text-center">Añadir Curso</button>
                        </div>
                    </div>
                </form>
                <div id="school-years-list" class="space-y-2">
                    <!-- Lista de cursos académicos -->
                </div>
            </div>
            <div id="data-management" class="tab-content">
                <div class="mt-4 space-y-4">
                    <div>
                        <h4 id="import-data-title" class="font-medium text-slate-900 mb-2"></h4>
                        <p id="import-data-desc" class="text-sm text-slate-500 mb-2"></p>
                        <input type="file" id="import-file" accept=".json" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                    </div>
                    <hr>
                    <div>
                        <h4 id="export-data-title" class="font-medium text-slate-900 mb-2"></h4>
                        <p id="export-data-desc" class="text-sm text-slate-500 mb-2"></p>
                        <div class="flex gap-2">
                            <button id="export-btn" class="flex-1 text-white bg-green-600 hover:bg-green-700 font-medium rounded-lg text-sm px-5 py-2.5 text-center"></button>
                            <button id="export-csv-btn" class="flex-1 text-white bg-indigo-600 hover:bg-indigo-700 font-medium rounded-lg text-sm px-5 py-2.5 text-center">Exportar a CSV</button>
                        </div>
                    </div>
                    <hr>
                     <div>
                        <h4 id="delete-data-title" class="font-medium text-red-600 mb-2"></h4>
                        <p id="delete-data-desc" class="text-sm text-slate-500 mb-2"></p>
                        <button id="delete-all-data-btn" class="w-full text-white bg-red-600 hover:bg-red-700 font-medium rounded-lg text-sm px-5 py-2.5 text-center"></button>
                    </div>
                </div>
            </div>
            <div id="pdf-settings" class="tab-content">
                <form id="pdf-config-form" class="mt-4 space-y-4">
                    <h4 class="font-medium text-slate-900 mb-2" id="pdf-header-settings-title"></h4>
                    <div>
                        <label for="pdf-header-title" id="label-pdf-header-title" class="block mb-2 text-sm font-medium text-slate-900"></label>
                        <input type="text" id="pdf-header-title" class="bg-stone-50 border border-stone-300 text-slate-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                    </div>
                    <div>
                        <label for="pdf-header-subtitle" id="label-pdf-header-subtitle" class="block mb-2 text-sm font-medium text-slate-900"></label>
                        <input type="text" id="pdf-header-subtitle" class="bg-stone-50 border border-stone-300 text-slate-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                    </div>
                    
                    <h4 class="font-medium text-slate-900 mb-2 mt-6" id="pdf-footer-settings-title"></h4>
                    <div>
                        <label for="pdf-footer-left" id="label-pdf-footer-left" class="block mb-2 text-sm font-medium text-slate-900"></label>
                        <input type="text" id="pdf-footer-left" class="bg-stone-50 border border-stone-300 text-slate-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                    </div>
                    <div>
                        <label for="pdf-footer-right" id="label-pdf-footer-right" class="block mb-2 text-sm font-medium text-slate-900"></label>
                        <input type="text" id="pdf-footer-right" class="bg-stone-50 border border-stone-300 text-slate-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                    </div>
                    
                    <h4 class="font-medium text-slate-900 mb-2 mt-6" id="pdf-agreement-settings-title"></h4>
                    <div>
                        <label for="pdf-agreement-text-es" id="label-pdf-agreement-text-es" class="block mb-2 text-sm font-medium text-slate-900"></label>
                        <textarea id="pdf-agreement-text-es" rows="4" class="block p-2.5 w-full text-sm text-slate-900 bg-stone-50 rounded-lg border border-stone-300 focus:ring-blue-500 focus:border-blue-500"></textarea>
                    </div>
                    <div>
                        <label for="pdf-agreement-text-eus" id="label-pdf-agreement-text-eus" class="block mb-2 text-sm font-medium text-slate-900"></label>
                        <textarea id="pdf-agreement-text-eus" rows="4" class="block p-2.5 w-full text-sm text-slate-900 bg-stone-50 rounded-lg border border-stone-300 focus:ring-blue-500 focus:border-blue-500"></textarea>
                    </div>
                    
                    <h4 class="font-medium text-slate-900 mb-2 mt-6" id="pdf-signature-settings-title"></h4>
                    <div>
                        <label for="pdf-signature-text-es" id="label-pdf-signature-text-es" class="block mb-2 text-sm font-medium text-slate-900"></label>
                        <input type="text" id="pdf-signature-text-es" class="bg-stone-50 border border-stone-300 text-slate-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                    </div>
                    <div>
                        <label for="pdf-signature-text-eus" id="label-pdf-signature-text-eus" class="block mb-2 text-sm font-medium text-slate-900"></label>
                        <input type="text" id="pdf-signature-text-eus" class="bg-stone-50 border border-stone-300 text-slate-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                    </div>
                    
                    <h4 class="font-medium text-slate-900 mb-2 mt-6" id="pdf-loaner-settings-title">Configuración de Texto de Préstamo</h4>
                    <div>
                        <label for="pdf-loaner-text-es" id="label-pdf-loaner-text-es" class="block mb-2 text-sm font-medium text-slate-900">Texto de Préstamo (Español)</label>
                        <textarea id="pdf-loaner-text-es" rows="4" class="block p-2.5 w-full text-sm text-slate-900 bg-stone-50 rounded-lg border border-stone-300 focus:ring-blue-500 focus:border-blue-500"></textarea>
                    </div>
                    <div>
                        <label for="pdf-loaner-text-eus" id="label-pdf-loaner-text-eus" class="block mb-2 text-sm font-medium text-slate-900">Texto de Préstamo (Euskera)</label>
                        <textarea id="pdf-loaner-text-eus" rows="4" class="block p-2.5 w-full text-sm text-slate-900 bg-stone-50 rounded-lg border border-stone-300 focus:ring-blue-500 focus:border-blue-500"></textarea>
                    </div>
                    
                    <div class="flex justify-end pt-4">
                        <button type="submit" id="save-pdf-config-btn" class="text-white bg-blue-600 hover:bg-blue-700 font-medium rounded-lg text-sm px-5 py-2.5 text-center"></button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!-- Loaner Chromebook Modal -->
    <div id="loaner-modal" class="modal-backdrop">
        <div class="modal-content bg-white rounded-xl shadow-xl p-8 m-4 relative">
             <button id="close-loaner-modal-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <h3 id="loaner-modal-title" class="text-2xl font-bold mb-6"></h3>
            <form id="loaner-form">
                <input type="hidden" id="loaner-id-hidden">
                <div class="mb-4">
                    <label for="loaner-id" id="label-loaner-id" class="block mb-2 text-sm font-medium text-slate-900"></label>
                    <input type="text" id="loaner-id" class="bg-stone-50 border border-stone-300 text-slate-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                </div>
                <div class="mb-4">
                    <label for="loaner-status" id="label-loaner-status" class="block mb-2 text-sm font-medium text-slate-900"></label>
                    <select id="loaner-status" class="bg-stone-50 border border-stone-300 text-slate-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                        <!-- Options populated by JS -->
                    </select>
                </div>
                <div id="loaner-assigned-to-section" class="mb-4 hidden">
                    <label for="loaner-assigned-to" id="label-loaner-assigned-to" class="block mb-2 text-sm font-medium text-slate-900"></label>
                    <select id="loaner-assigned-to" class="bg-stone-50 border border-stone-300 text-slate-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                        <!-- Options populated by JS -->
                    </select>
                </div>
                <div class="flex justify-end">
                    <button type="submit" id="save-loaner-btn" class="text-white bg-purple-600 hover:bg-purple-700 font-medium rounded-lg text-sm px-5 py-2.5 text-center"></button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Reports Modal -->
    <div id="reports-modal" class="modal-backdrop">
        <div class="modal-content bg-white rounded-xl shadow-xl p-8 m-4 relative">
            <button id="close-reports-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <h3 id="reports-modal-title" class="text-2xl font-bold mb-6"></h3>
            
            <div class="space-y-6">
                <!-- Report by Status -->
                <div class="p-4 border rounded-lg">
                    <h4 id="report-by-status-title" class="text-lg font-semibold mb-2"></h4>
                    <div class="flex items-center gap-4">
                        <select id="report-status-filter" multiple class="bg-stone-50 border border-stone-200 text-slate-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5"></select>
                        <div class="flex items-center">
                            <input id="sum-cost-checkbox" type="checkbox" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500">
                            <label for="sum-cost-checkbox" id="label-sum-cost" class="ml-2 text-sm font-medium text-gray-900"></label>
                        </div>
                        <button id="generate-status-report-btn" class="text-white bg-blue-600 hover:bg-blue-700 font-medium rounded-lg text-sm px-5 py-2.5 text-center"></button>
                    </div>
                </div>
                <!-- Report by Student -->
                <div class="p-4 border rounded-lg">
                    <h4 id="report-by-student-title" class="text-lg font-semibold mb-2"></h4>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                        <div class="md:col-span-1 relative">
                             <label for="report-student-name" id="label-report-student-name" class="block mb-1 text-sm font-medium text-slate-900"></label>
                            <input type="text" id="report-student-name" class="bg-stone-50 border border-stone-300 text-slate-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                            <div id="report-student-suggestions" class="absolute z-10 w-full bg-white border border-stone-300 rounded-lg mt-1 max-h-40 overflow-y-auto shadow-lg hidden"></div>
                        </div>
                        <div>
                             <label for="report-student-start-date" id="label-report-start-date" class="block mb-1 text-sm font-medium text-slate-900"></label>
                            <input type="date" id="report-student-start-date" class="bg-stone-50 border border-stone-300 text-slate-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                        </div>
                        <div>
                            <label for="report-student-end-date" id="label-report-end-date" class="block mb-1 text-sm font-medium text-slate-900"></label>
                            <input type="date" id="report-student-end-date" class="bg-stone-50 border border-stone-300 text-slate-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                        </div>
                        <button id="generate-student-report-btn" class="text-white bg-blue-600 hover:bg-blue-700 font-medium rounded-lg text-sm px-5 py-2.5 text-center"></button>
                    </div>
                </div>
                 <!-- Report by Class -->
                <div class="p-4 border rounded-lg">
                    <h4 id="report-by-class-title" class="text-lg font-semibold mb-2"></h4>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                        <div class="md:col-span-1">
                            <label for="report-class-filter" id="label-report-class-filter" class="block mb-1 text-sm font-medium text-slate-900"></label>
                            <select id="report-class-filter" class="bg-stone-50 border border-stone-300 text-slate-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5"></select>
                        </div>
                        <div>
                            <label for="report-class-start-date" id="label-report-class-start-date" class="block mb-1 text-sm font-medium text-slate-900"></label>
                            <input type="date" id="report-class-start-date" class="bg-stone-50 border border-stone-300 text-slate-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                        </div>
                        <div>
                            <label for="report-class-end-date" id="label-report-class-end-date" class="block mb-1 text-sm font-medium text-slate-900"></label>
                            <input type="date" id="report-class-end-date" class="bg-stone-50 border border-stone-300 text-slate-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                        </div>
                        <button id="generate-class-report-btn" class="text-white bg-blue-600 hover:bg-blue-700 font-medium rounded-lg text-sm px-5 py-2.5 text-center"></button>
                    </div>
                </div>
                <!-- Total Repairs by Class Report -->
                <div class="p-4 border rounded-lg">
                    <h4 id="report-total-by-class-title" class="text-lg font-semibold mb-2">Total de Reparaciones por Clase</h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                        <div>
                            <label for="total-class-start-date" id="label-total-class-start-date" class="block mb-1 text-sm font-medium text-slate-900">Fecha Inicio</label>
                            <input type="date" id="total-class-start-date" class="bg-stone-50 border border-stone-300 text-slate-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                        </div>
                        <div>
                            <label for="total-class-end-date" id="label-total-class-end-date" class="block mb-1 text-sm font-medium text-slate-900">Fecha Fin</label>
                            <input type="date" id="total-class-end-date" class="bg-stone-50 border border-stone-300 text-slate-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                        </div>
                        <button id="generate-total-class-report-btn" class="text-white bg-blue-600 hover:bg-blue-700 font-medium rounded-lg text-sm px-5 py-2.5 text-center">Generar Informe</button>
                    </div>
                </div>
                <!-- Total Repairs by Student Report -->
                <div class="p-4 border rounded-lg">
                    <h4 id="report-total-by-student-title" class="text-lg font-semibold mb-2">Total de Reparaciones por Alumno</h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                        <div>
                            <label for="total-student-start-date" id="label-total-student-start-date" class="block mb-1 text-sm font-medium text-slate-900">Fecha Inicio</label>
                            <input type="date" id="total-student-start-date" class="bg-stone-50 border border-stone-300 text-slate-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                        </div>
                        <div>
                            <label for="total-student-end-date" id="label-total-student-end-date" class="block mb-1 text-sm font-medium text-slate-900">Fecha Fin</label>
                            <input type="date" id="total-student-end-date" class="bg-stone-50 border border-stone-300 text-slate-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                        </div>
                        <button id="generate-total-student-report-btn" class="text-white bg-blue-600 hover:bg-blue-700 font-medium rounded-lg text-sm px-5 py-2.5 text-center">Generar Informe</button>
                    </div>
                </div>
                <!-- Summary Report -->
                <div class="p-4 border rounded-lg">
                    <h4 id="report-summary-title" class="text-lg font-semibold mb-2">Informe Resumen</h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                        <div>
                            <label for="summary-start-date" id="label-summary-start-date" class="block mb-1 text-sm font-medium text-slate-900">Fecha Inicio</label>
                            <input type="date" id="summary-start-date" class="bg-stone-50 border border-stone-300 text-slate-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                        </div>
                        <div>
                            <label for="summary-end-date" id="label-summary-end-date" class="block mb-1 text-sm font-medium text-slate-900">Fecha Fin</label>
                            <input type="date" id="summary-end-date" class="bg-stone-50 border border-stone-300 text-slate-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                        </div>
                        <button id="generate-summary-report-btn" class="text-white bg-blue-600 hover:bg-blue-700 font-medium rounded-lg text-sm px-5 py-2.5 text-center">Generar Resumen</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- SAMPLE DATA GENERATION ---
            const createSampleData = () => {
                const sampleRepairs = [
                    {
                        id: 'CB-1722931200001', studentName: 'Ane García', className: 'DBH 1',
                        description: 'La pantalla no enciende después de una caída.',
                        status: 'pending', reportedDate: '2025-08-01', repairedDate: null,
                        notes: '01/08/2025 10:00: Recibido. Pendiente de revisión por técnico.',
                        photos: [], hasCost: false, costAmount: 0, loanerChromebook: '',
                        serialNumber: 'SN123456789' // Número de serie añadido
                    },
                    {
                        id: 'CB-1722931200002', studentName: 'Jon Martinez', className: 'DBH 2',
                        description: 'El teclado no responde. Algunas teclas están atascadas.',
                        status: 'in_progress', reportedDate: '2025-07-28', repairedDate: null,
                        notes: '28/07/2025 12:30: Se ha pedido un teclado de reemplazo.\n30/07/2025 09:15: A la espera de recibir la pieza.',
                        photos: [], hasCost: true, costAmount: 45.50, loanerChromebook: 'LOAN-01',
                        serialNumber: 'SN987654321' // Número de serie añadido
                    },
                    {
                        id: 'CB-1722931200003', studentName: 'Leire Zabala', className: 'BAT 1',
                        description: 'La batería no carga y el equipo se apaga constantemente.',
                        status: 'repaired', reportedDate: '2025-07-15', repairedDate: '2025-07-18',
                        notes: '15/07/2025 14:00: Diagnóstico: batería defectuosa.\n18/07/2025 11:00: Batería reemplazada y sistema verificado. Reparación completada.',
                        photos: [], hasCost: true, costAmount: 60.00, loanerChromebook: '',
                        serialNumber: 'SN456789123' // Número de serie añadido
                    },
                    {
                        id: 'CB-1722931200004', studentName: 'Iker Romero', className: 'DBH 4',
                        description: 'La carcasa está rota y la bisagra de la pantalla está suelta.',
                        status: 'unrepairable', reportedDate: '2025-07-20', repairedDate: null,
                        notes: '20/07/2025 09:00: Daño estructural severo. El coste de la reparación supera el valor del equipo. Se declara no reparable.',
                        photos: [], hasCost: false, costAmount: 0, loanerChromebook: '',
                        serialNumber: 'SN789123456' // Número de serie añadido
                    },
                    {
                        id: 'CB-1722931200005', studentName: 'Maialen Aguirre', className: 'DBH 3',
                        description: 'El sistema operativo no arranca, se queda en el logo de Chrome.',
                        status: 'pending', reportedDate: '2025-08-05', repairedDate: null,
                        notes: '05/08/2025 16:00: Pendiente de realizar un reseteo de fábrica (powerwash).',
                        photos: [], hasCost: false, costAmount: 0, loanerChromebook: '',
                        serialNumber: 'SN321654987' // Número de serie añadido
                    }
                ];
                const sampleLoaners = [
                    { id: 'LOAN-01', status: 'assigned', assignedTo: 'CB-1722931200002', returnDate: '2025-08-15' },
                    { id: 'LOAN-02', status: 'available', assignedTo: '', returnDate: '' },
                    { id: 'LOAN-03', status: 'available', assignedTo: '', returnDate: '' },
                    { id: 'LOAN-04', status: 'maintenance', assignedTo: '', returnDate: '' }
                ];
                localStorage.setItem('repairs', JSON.stringify(sampleRepairs));
                localStorage.setItem('loanerChromebooks', JSON.stringify(sampleLoaners));
                return { repairs: sampleRepairs, loaners: sampleLoaners };
            };
            // --- STATE MANAGEMENT ---
            let repairsData = JSON.parse(localStorage.getItem('repairs'));
            let loanerData = JSON.parse(localStorage.getItem('loanerChromebooks'));
            if (!repairsData) {
                const sampleData = createSampleData();
                repairsData = sampleData.repairs;
                loanerData = sampleData.loaners;
            }
            let repairs = repairsData;
            let loanerChromebooks = loanerData;
            
            let config = JSON.parse(localStorage.getItem('config')) || {
                appName: 'Panel de Averías',
                appDescription: 'Gestión de reparaciones de Chromebooks',
                appLogoUrl: '',
                language: 'es',
                classGroups: ['DBH 1', 'DBH 2', 'DBH 3', 'DBH 4', 'BAT 1', 'BAT 2'],
                contactEmail: 'contacto@centroeducativo.com',
                schoolYears: [
                    { name: '2023-2024', startDate: '2023-09-01', endDate: '2024-07-15' },
                    { name: '2024-2025', startDate: '2024-09-01', endDate: '2025-07-15' }
                ],
                pdfConfig: {
                    headerTitle: 'Informe de Reparación',
                    headerSubtitle: 'Centro Educativo',
                    footerLeft: 'Centro Educativo',
                    footerRight: 'Página {page}',
                    agreementTextEs: 'Este documento detalla la avería reportada para el Chromebook asignado al alumno/a. La reparación puede incurrir en costes si se determina que el daño fue causado por un mal uso. Para cualquier consulta, por favor contacte con nosotros en la siguiente dirección de correo electrónico: {email}. La firma a continuación implica la aceptación de las condiciones de reparación y la recepción de este informe.',
                    agreementTextEus: 'Dokumentu honek ikasleari esleitutako Chromebook-erako jakinarazitako matxura zehazten du. Konponketak kostuak ekar ditzake kaltea erabilera desegokiagatik izan dela zehazten bada. Edozein zalantza argitzeko, jar zaitez gurekin harremanetan hurrengo helbide elektronikoan: {email}. Beheko sinadurak konponketa baldintzak onartzen dituzula eta txosten hau jaso duzula esan nahi du.',
                    signatureTextEs: 'Firma de los padres / tutor legal:',
                    signatureTextEus: 'Gurasoen / legezko tutorearen sinadura:',
                    // Nuevos campos para el texto del Chromebook de préstamo
                    loanerTextEs: 'El Chromebook de préstamo se le entrega al alumno mientras se soluciona el problema. En caso de no aceptar las condiciones, el alumno tendrá un plazo de un mes a partir de la fecha de la avería para hacerse con otro Chromebook por su cuenta. Transcurrido ese mes, el Chromebook prestado tendrá que devolverlo. El Chromebook prestado debe ser devuelto en buenas condiciones. En caso de ruptura, el alumno se hará cargo del coste de reparación.',
                    loanerTextEus: 'Maileguaren Chromebook-a ikasleari ematen zaio arazoa konbitzen den bitartean. Baldintzak onartzen ez badira, ikasleak hilabete bat izango du matxuraren datatik aurrera bere Chromebook-a lortzeko. Hilabete hori igaro ondoren, maileguan emandako Chromebook-a itzuli beharko da. Maileguan emandako Chromebook-a egoera onean itzuli behar da. Apurtuz gero, ikasleak konponketaren kostua bere gain hartuko du.'
                }
            };
            let editingRepairId = null;
            let editingLoanerId = null;
            let repairsChart = null;
            let monthlyChart = null;
            let classChart = null;
            let studentsChart = null;
            let cameraStream = null;
            let currentSort = { column: 'id', order: 'asc' };
            const selectedRepairIds = new Set();
            let modalPhotos = [];
            
            // Variables para la paginación
            let currentPage = 1;
            let pageSize = 10;
            let filteredRepairs = [...repairs];
            
            // --- SCHOOL YEAR MANAGEMENT ---
            const getCurrentSchoolYear = () => {
                const now = new Date();
                const year = now.getFullYear();
                const month = now.getMonth();
                const day = now.getDate();
                
                // Si estamos entre el 16 de julio y el 31 de agosto, el curso actual es el anterior
                if ((month === 6 && day >= 16) || month === 7) {
                    return `${year - 1}-${year}`;
                }
                
                // Si no, el curso actual es el año en curso y el siguiente
                return `${year}-${year + 1}`;
            };
            
            const getAvailableSchoolYears = (count = 5) => {
                // Si tenemos cursos académicos definidos en la configuración, los usamos
                if (config.schoolYears && config.schoolYears.length > 0) {
                    return config.schoolYears.map(sy => sy.name);
                }
                
                // Si no, generamos cursos automáticamente
                const currentYear = getCurrentSchoolYear();
                const [startYear] = currentYear.split('-').map(Number);
                const years = [];
                
                for (let i = 0; i < count; i++) {
                    const yearStart = startYear - i;
                    const yearEnd = yearStart + 1;
                    years.push(`${yearStart}-${yearEnd}`);
                }
                
                return years;
            };
            
            const getSchoolYearDates = (schoolYear) => {
                // Si tenemos cursos académicos definidos en la configuración, buscamos el curso
                if (config.schoolYears && config.schoolYears.length > 0) {
                    const schoolYearConfig = config.schoolYears.find(sy => sy.name === schoolYear);
                    if (schoolYearConfig) {
                        return {
                            startDate: new Date(schoolYearConfig.startDate),
                            endDate: new Date(schoolYearConfig.endDate)
                        };
                    }
                }
                
                // Si no, usamos la lógica predeterminada
                const [startYear, endYear] = schoolYear.split('-').map(Number);
                return {
                    startDate: new Date(startYear, 8, 1), // 1 de septiembre (mes 8, enero es 0)
                    endDate: new Date(endYear, 6, 15)   // 15 de julio (mes 6)
                };
            };
            
            const filterRepairsBySchoolYear = (repairsList, schoolYear) => {
                if (!schoolYear) return repairsList;
                
                const { startDate, endDate } = getSchoolYearDates(schoolYear);
                
                return repairsList.filter(repair => {
                    const repairDate = new Date(repair.reportedDate);
                    return repairDate >= startDate && repairDate <= endDate;
                });
            };
            
            let selectedSchoolYear = getCurrentSchoolYear();
            
            // --- TRANSLATIONS ---
            const translations = {
                es: {
                    'Panel de Averías': 'Panel de Averías',
                    'Gestión de reparaciones de Chromebooks': 'Gestión de reparaciones de Chromebooks',
                    'reports-btn': 'Informes',
                    'config-btn': 'Configuración',
                    'kpi-total-chromebooks-label': 'Total Averías',
                    'kpi-pending-repairs-label': 'Pendientes',
                    'kpi-in-progress-repairs-label': 'En Reparación',
                    'kpi-repaired-month-label': 'Reparados (Mes)',
                    'kpi-available-loaners-label': 'Préstamo Disp.',
                    'repairs-list-title': 'Listado de Averías',
                    'search-input-placeholder': 'Buscar por ID, alumno, clase...',
                    'add-repair-btn': 'Añadir Avería',
                    'delete-selected-repairs-btn': 'Eliminar Selección',
                    'table-header-student': 'Alumno/a',
                    'table-header-class': 'Clase',
                    'table-header-status': 'Estado',
                    'table-header-reported-date': 'Fecha Reporte',
                    'table-header-repaired-date': 'Fecha Reparación',
                    'table-header-actions': 'Acciones',
                    'no-results-p': 'No se encontraron averías que coincidan con la búsqueda.',
                    'status-chart-title': 'Desglose de Estados',
                    'loaner-management-title': 'Gestión de Chromebooks de Préstamo',
                    'add-loaner-btn': 'Añadir Préstamo',
                    'loaner-table-header-id': 'ID Préstamo',
                    'loaner-table-header-status': 'Estado',
                    'loaner-table-header-assigned-to': 'Asignado a',
                    'loaner-table-header-actions': 'Acciones',
                    'no-loaner-results-p': 'No hay Chromebooks de préstamo registrados.',
                    'modalTitleAdd': 'Añadir Nueva Avería',
                    'modalTitleEdit': 'Editar Avería',
                    'label-repair-student-name': 'Nombre del Alumno/a',
                    'label-repair-class-name': 'Clase',
                    'label-repair-description': 'Descripción de la Avería',
                    'label-repair-status': 'Estado',
                    'label-repair-reported-date': 'Fecha del Reporte',
                    'label-repair-notes': 'Notas de Seguimiento (añadir nueva)',
                    'label-photo-section': 'Fotos de la Avería',
                    'photo-placeholder': 'Arrastra imágenes o usa la cámara',
                    'upload-photo-btn': 'Subir Foto(s)',
                    'capture-photo-btn': 'Iniciar Cámara',
                    'take-picture-btn': 'Tomar Foto',
                    'label-has-cost': 'La reparación tiene coste',
                    'label-cost-amount': 'Importe del Coste (€)',
                    'save-repair-btn': 'Guardar Cambios',
                    'config-modal-title': 'Configuración de la Aplicación',
                    'tab-general-settings': 'General',
                    'tab-class-management': 'Gestión de Clases',
                    'tab-school-year-management': 'Gestión de Cursos Académicos',
                    'tab-data-management': 'Gestión de Datos',
                    'tab-pdf-settings': 'Configuración PDF',
                    'label-app-name': 'Nombre de la Aplicación',
                    'label-app-description': 'Descripción Breve',
                    'label-app-logo': 'Logo de la Aplicación',
                    'label-language-selector': 'Idioma',
                    'label-contact-email': 'Email de Contacto para Informes',
                    'save-config-btn': 'Guardar Configuración',
                    'new-class-group-input-placeholder': 'Nombre de la nueva clase',
                    'add-class-group-btn': 'Añadir',
                    'import-data-title': 'Importar Datos',
                    'import-data-desc': 'Selecciona un archivo JSON para restaurar los datos de averías y préstamos.',
                    'export-data-title': 'Exportar Datos',
                    'export-data-desc': 'Guarda todas las averías y préstamos en un archivo JSON.',
                    'export-btn': 'Exportar a JSON',
                    'export-csv-btn': 'Exportar a CSV',
                    'delete-data-title': 'Zona de Peligro',
                    'delete-data-desc': 'Elimina permanentemente todos los datos de averías y préstamos. Esta acción no se puede deshacer.',
                    'delete-all-data-btn': 'Eliminar Todos los Datos',
                    'loanerModalTitleAdd': 'Añadir Chromebook de Préstamo',
                    'loanerModalTitleEdit': 'Editar Chromebook de Préstamo',
                    'label-loaner-id': 'Identificador del Chromebook',
                    'label-loaner-status': 'Estado',
                    'label-loaner-assigned-to': 'Asignar a Avería (ID)',
                    'save-loaner-btn': 'Guardar',
                    'reports-modal-title': 'Generar Informes',
                    'report-by-status-title': 'Informe por Estado',
                    'report-by-class-title': 'Informe por Clase',
                    'generate-class-report-btn': 'Generar PDF',
                    'label-sum-cost': 'Sumar costes',
                    'generate-status-report-btn': 'Generar PDF',
                    'report-by-student-title': 'Informe por Alumno/a',
                    'label-report-student-name': 'Nombre del Alumno/a',
                    'label-report-start-date': 'Fecha Inicio',
                    'label-report-end-date': 'Fecha Fin',
                    'generate-student-report-btn': 'Generar PDF',
                    'label-report-class-filter': 'Clase',
                    'label-report-class-start-date': 'Fecha Inicio',
                    'label-report-class-end-date': 'Fecha Fin',
                    'confirmDelete': '¿Estás seguro de que quieres eliminar esta avería?',
                    'confirmDeleteSelected': '¿Estás seguro de que quieres eliminar las averías seleccionadas?',
                    'confirmDeleteLoaner': '¿Estás seguro de que quieres eliminar este Chromebook de préstamo?',
                    'confirmDeleteAllData': '¡ADVERTENCIA! ¿Estás seguro de que quieres eliminar TODOS los datos? Esta acción es irreversible.',
                    'status_pending': 'Pendiente',
                    'status_in_progress': 'En Reparación',
                    'status_repaired': 'Reparado',
                    'status_unrepairable': 'No Reparable',
                    'status_loaner_available': 'Disponible',
                    'status_loaner_assigned': 'Asignado',
                    'status_loaner_maintenance': 'En Mantenimiento',
                    'filter_all': 'Todos los Estados',
                    'labelId': 'ID Avería',
                    'labelStudentName': 'Alumno/a',
                    'labelClassName': 'Clase',
                    'labelStatus': 'Egoera',
                    'labelReportedDate': 'Fecha Reporte',
                    'labelRepairedDate': 'Fecha Reparación',
                    'labelDescription': 'Descripción',
                    'labelNotes': 'Notas',
                    'labelHasCost': 'Tiene Coste',
                    'labelCostAmount': 'Importe (€)',
                    'labelLoanerChromebook': 'Chromebook Préstamo',
                    'labelSumTotalCost': 'Suma Total de Costes',
                    'pdf-parent-agreement': 'Este documento detalla la avería reportada para el Chromebook asignado al alumno/a. La reparación puede incurrir en costes si se determina que el daño fue causado por un mal uso. Para cualquier consulta, por favor contacte con nosotros en la siguiente dirección de correo electrónico: {email}. La firma a continuación implica la aceptación de las condiciones de reparación y la recepción de este informe.',
                    'pdf-signature-line': 'Firma de los padres / tutor legal:',
                    // Nuevas traducciones para la sección de préstamo
                    'label-loaner-section': 'Préstamo de Chromebook',
                    'label-loaner-select': 'Seleccionar Chromebook de préstamo',
                    'label-loaner-return-date': 'Fecha de devolución prevista',
                    'assign-loaner-btn': 'Asignar Préstamo',
                    'unassign-loaner-btn': 'Devolver Préstamo',
                    'loaner-status-assigned': 'Asignado',
                    'loaner-status-not-assigned': 'No asignado',
                    // Traducciones para la configuración de PDFs
                    'pdf-header-settings-title': 'Configuración de Encabezado',
                    'label-pdf-header-title': 'Título del Encabezado',
                    'label-pdf-header-subtitle': 'Subtítulo del Encabezado',
                    'pdf-footer-settings-title': 'Configuración de Pie de Página',
                    'label-pdf-footer-left': 'Texto Izquierdo del Pie',
                    'label-pdf-footer-right': 'Texto Derecho del Pie',
                    'pdf-agreement-settings-title': 'Configuración de Texto de Acuerdo',
                    'label-pdf-agreement-text-es': 'Texto de Acuerdo (Español)',
                    'label-pdf-agreement-text-eus': 'Texto de Acuerdo (Euskera)',
                    'pdf-signature-settings-title': 'Configuración de Texto de Firma',
                    'label-pdf-signature-text-es': 'Texto de Firma (Español)',
                    'label-pdf-signature-text-eus': 'Texto de Firma (Euskera)',
                    'save-pdf-config-btn': 'Guardar Configuración PDF',
                    // Nuevas traducciones para el informe resumen
                    'report-summary-title': 'Informe Resumen',
                    'label-summary-start-date': 'Fecha Inicio',
                    'label-summary-end-date': 'Fecha Fin',
                    'generate-summary-report-btn': 'Generar Resumen',
                    'summary-general-title': 'Resumen General',
                    'summary-total-repairs': 'Total de Averías',
                    'summary-total-cost': 'Coste Total',
                    'summary-by-class-title': 'Resumen por Clase',
                    'summary-top-students-title': 'Top 10 Alumnos con Más Averías',
                    'summary-position': 'Posición',
                    'summary-student-name': 'Nombre del Alumno',
                    'summary-repairs-count': 'Número de Averías',
                    'summary-average-cost': 'Coste Medio por Avería',
                    'summary-generated-on': 'Generado el',
                    // Nuevas traducciones para la información del préstamo en PDF
                    'loaner-status-not-assigned': 'No se ha asignado Chromebook de préstamo',
                    'label-loaner-id': 'ID Préstamo',
                    'label-loaner-status': 'Estado Préstamo',
                    // Nuevas traducciones para los informes totales
                    'report-total-by-class-title': 'Total de Reparaciones por Clase',
                    'report-total-by-student-title': 'Total de Reparaciones por Alumno',
                    'label-total-class-start-date': 'Fecha Inicio',
                    'label-total-class-end-date': 'Fecha Fin',
                    'label-total-student-start-date': 'Fecha Inicio',
                    'label-total-student-end-date': 'Fecha Fin',
                    'generate-total-class-report-btn': 'Generar Informe',
                    'generate-total-student-report-btn': 'Generar Informe',
                    'total-class-report-title': 'Informe Total por Clase',
                    'total-student-report-title': 'Informe Total por Alumno',
                    'total-class-name': 'Clase',
                    'total-repairs-count': 'Total Reparaciones',
                    'total-student-name': 'Alumno',
                    'total-class-period': 'Periodo',
                    'total-student-period': 'Periodo',
                    // Nuevas traducciones para la sección de estadísticas
                    'stats-title': 'Estadísticas',
                    'monthly-stats-title': 'Averías por Mes',
                    'class-stats-title': 'Averías por Clase',
                    'student-stats-title': 'Top 5 Alumnos con Más Averías',
                    // Traducción para el selector de curso escolar
                    'label-school-year': 'Curso escolar:',
                    // Traducciones para la gestión de cursos académicos
                    'school-year-management-title': 'Gestión de Cursos Académicos',
                    'school-year-name-label': 'Nombre del Curso',
                    'school-year-start-date-label': 'Fecha de Inicio',
                    'school-year-end-date-label': 'Fecha de Fin',
                    'add-school-year-btn': 'Añadir Curso',
                    'delete-school-year-confirm': '¿Estás seguro de que quieres eliminar este curso académico?',
                    // Nuevas traducciones para la configuración de préstamo
                    'pdf-loaner-settings-title': 'Configuración de Texto de Préstamo',
                    'label-pdf-loaner-text-es': 'Texto de Préstamo (Español)',
                    'label-pdf-loaner-text-eus': 'Texto de Préstamo (Euskera)'
                },
                eus: {
                    'Panel de Averías': 'Matxuren Panela',
                    'Gestión de reparaciones de Chromebooks': 'Chromebook-en konponketen kudeaketa',
                    'reports-btn': 'Txostenak',
                    'config-btn': 'Konfigurazioa',
                    'kpi-total-chromebooks-label': 'Matxurak Guztira',
                    'kpi-pending-repairs-label': 'Zain',
                    'kpi-in-progress-repairs-label': 'Konpontzen',
                    'kpi-repaired-month-label': 'Konponduak (Hilabetea)',
                    'kpi-available-loaners-label': 'Maileguak Eskuragarri',
                    'repairs-list-title': 'Matxuren Zerrenda',
                    'search-input-placeholder': 'Bilatu ID, ikasle, gelaren arabera...',
                    'add-repair-btn': 'Matxura Gehitu',
                    'delete-selected-repairs-btn': 'Hautatuak Ezabatu',
                    'table-header-student': 'Ikaslea',
                    'table-header-class': 'Gela',
                    'table-header-status': 'Egoera',
                    'table-header-reported-date': 'Txosten Data',
                    'table-header-repaired-date': 'Konponketa Data',
                    'table-header-actions': 'Ekintzak',
                    'no-results-p': 'Ez da bilaketarekin bat datorren matxurarik aurkitu.',
                    'status-chart-title': 'Egoeren Banaketa',
                    'loaner-management-title': 'Mailegu Chromebook-en Kudeaketa',
                    'add-loaner-btn': 'Mailegua Gehitu',
                    'loaner-table-header-id': 'Mailegu IDa',
                    'loaner-table-header-status': 'Egoera',
                    'loaner-table-header-assigned-to': 'Nori esleitua',
                    'loaner-table-header-actions': 'Ekintzak',
                    'no-loaner-results-p': 'Ez dago erregistratutako mailegu Chromebook-ik.',
                    'modalTitleAdd': 'Matxura Berria Gehitu',
                    'modalTitleEdit': 'Matxura Editatu',
                    'label-repair-student-name': 'Ikaslearen Izena',
                    'label-repair-class-name': 'Gela',
                    'label-repair-description': 'Matxuraren Deskribapena',
                    'label-repair-status': 'Egoera',
                    'label-repair-reported-date': 'Txostenaren Data',
                    'label-repair-notes': 'Jarraipen Oharrak (berria gehitu)',
                    'label-photo-section': 'Matxuraren Argazkiak',
                    'photo-placeholder': 'Arrastatu irudiak edo erabili kamera',
                    'upload-photo-btn': 'Argazkiak Igo',
                    'capture-photo-btn': 'Kamera Hasi',
                    'take-picture-btn': 'Argazkia Atera',
                    'label-has-cost': 'Konponketak kostua du',
                    'label-cost-amount': 'Kostuaren Zenbatekoa (€)',
                    'save-repair-btn': 'Aldaketak Gorde',
                    'config-modal-title': 'Aplikazioaren Konfigurazioa',
                    'tab-general-settings': 'Orokorra',
                    'tab-class-management': 'Gelen Kudeaketa',
                    'tab-school-year-management': 'Ikasturteen Kudeaketa',
                    'tab-data-management': 'Datuen Kudeaketa',
                    'tab-pdf-settings': 'PDF Konfigurazioa',
                    'label-app-name': 'Aplikazioaren Izena',
                    'label-app-description': 'Deskribapen Laburra',
                    'label-app-logo': 'Aplikazioaren Logoa',
                    'label-language-selector': 'Hizkuntza',
                    'label-contact-email': 'Txostenetarako Harremanetarako E-posta',
                    'save-config-btn': 'Konfigurazioa Gorde',
                    'new-class-group-input-placeholder': 'Gela berriaren izena',
                    'add-class-group-btn': 'Gehitu',
                    'import-data-title': 'Datuak Inportatu',
                    'import-data-desc': 'Hautatu JSON fitxategi bat matxuren eta maileguen datuak leheneratzeko.',
                    'export-data-title': 'Datuak Esportatu',
                    'export-data-desc': 'Gorde matxura eta mailegu guztiak JSON fitxategi batean.',
                    'export-btn': 'JSONera Esportatu',
                    'export-csv-btn': 'CSVra Esportatu',
                    'delete-data-title': 'Arrisku Gunea',
                    'delete-data-desc': 'Matxuren eta maileguen datu guztiak betirako ezabatzen ditu. Ekintza hau ezin da desegin.',
                    'delete-all-data-btn': 'Datu Guztiak Ezabatu',
                    'loanerModalTitleAdd': 'Mailegu Chromebook Gehitu',
                    'loanerModalTitleEdit': 'Mailegu Chromebook Editatu',
                    'label-loaner-id': 'Chromebook-aren Identifikatzailea',
                    'label-loaner-status': 'Egoera',
                    'label-loaner-assigned-to': 'Matxurari Esleitu (ID)',
                    'save-loaner-btn': 'Gorde',
                    'reports-modal-title': 'Txostenak Sortu',
                    'report-by-status-title': 'Txostena Egoeraren Arabera',
                    'report-by-class-title': 'Txostena Gelaren Arabera',
                    'generate-class-report-btn': 'PDFa Sortu',
                    'label-sum-cost': 'Kostuak batu',
                    'generate-status-report-btn': 'PDFa Sortu',
                    'report-by-student-title': 'Txostena Ikaslearen Arabera',
                    'label-report-student-name': 'Ikaslearen Izena',
                    'label-report-start-date': 'Hasiera Data',
                    'label-report-end-date': 'Amaiera Data',
                    'generate-student-report-btn': 'PDFa Sortu',
                    'label-report-class-filter': 'Gela',
                    'label-report-class-start-date': 'Hasiera Data',
                    'label-report-class-end-date': 'Amaiera Data',
                    'confirmDelete': 'Ziur zaude matxura hau ezabatu nahi duzula?',
                    'confirmDeleteSelected': 'Ziur zaude hautatutako matxurak ezabatu dituzula?',
                    'confirmDeleteLoaner': 'Ziur zaude mailegu Chromebook hau ezabatu nahi duzula?',
                    'confirmDeleteAllData': 'KONTUZ! Ziur zaude datu GUZTIAK ezabatu nahi dituzula? Ekintza hau atzeraezina da.',
                    'status_pending': 'Zain',
                    'status_in_progress': 'Konpontzen',
                    'status_repaired': 'Konponduta',
                    'status_unrepairable': 'Konponezina',
                    'status_loaner_available': 'Eskuragarri',
                    'status_loaner_assigned': 'Esleituta',
                    'status_loaner_maintenance': 'Mantenimenduan',
                    'filter_all': 'Egoera Guztiak',
                    'labelId': 'Matxura IDa',
                    'labelStudentName': 'Ikaslea',
                    'labelClassName': 'Gela',
                    'labelStatus': 'Egoera',
                    'labelReportedDate': 'Txosten Data',
                    'labelRepairedDate': 'Konponketa Data',
                    'labelDescription': 'Deskribapena',
                    'labelNotes': 'Oharrak',
                    'labelHasCost': 'Kostua Dauka',
                    'labelCostAmount': 'Zenbatekoa (€)',
                    'labelLoanerChromebook': 'Mailegu Chromebook',
                    'labelSumTotalCost': 'Kostuen Batura Guztira',
                    'pdf-parent-agreement': 'Dokumentu honek ikasleari esleitutako Chromebook-erako jakinarazitako matxura zehazten du. Konponketak kostuak ekar ditzake kaltea erabilera desegokiagatik izan dela zehazten bada. Edozein zalantza argitzeko, jar zaitez gurekin harremanetan hurrengo helbide elektronikoan: {email}. Beheko sinadurak konponketa baldintzak onartzen dituzula eta txosten hau jaso duzula esan nahi du.',
                    'pdf-signature-line': 'Gurasoen / legezko tutorearen sinadura:',
                    // Nuevas traducciones para la sección de préstamo
                    'label-loaner-section': 'Chromebook Mailegua',
                    'label-loaner-select': 'Hautatu maileguko Chromebooka',
                    'label-loaner-return-date': 'Itzultze data aurreikusia',
                    'assign-loaner-btn': 'Esleitu Mailegua',
                    'unassign-loaner-btn': 'Itzuli Mailegua',
                    'loaner-status-assigned': 'Esleituta',
                    'loaner-status-not-assigned': 'Esleitu gabe',
                    // Traducciones para la configuración de PDFs
                    'pdf-header-settings-title': 'Goiburuen Konfigurazioa',
                    'label-pdf-header-title': 'Goiburuko Izenburua',
                    'label-pdf-header-subtitle': 'Goiburuko Azpiizenburua',
                    'pdf-footer-settings-title': 'Orri Oinen Konfigurazioa',
                    'label-pdf-footer-left': 'Orri Oineko Ezkerreko Testua',
                    'label-pdf-footer-right': 'Orri Oineko Eskuineko Testua',
                    'pdf-agreement-settings-title': 'Akordio Testuaren Konfigurazioa',
                    'label-pdf-agreement-text-es': 'Akordio Testua (Gaztelaniaz)',
                    'label-pdf-agreement-text-eus': 'Akordio Testua (Euskaraz)',
                    'pdf-signature-settings-title': 'Sinadura Testuaren Konfigurazioa',
                    'label-pdf-signature-text-es': 'Sinadura Testua (Gaztelaniaz)',
                    'label-pdf-signature-text-eus': 'Sinadura Testua (Euskaraz)',
                    'save-pdf-config-btn': 'Gorde PDF Konfigurazioa',
                    // Nuevas traducciones para el informe resumen
                    'report-summary-title': 'Txosten Laburpena',
                    'label-summary-start-date': 'Hasiera Data',
                    'label-summary-end-date': 'Amaiera Data',
                    'generate-summary-report-btn': 'Laburpena Sortu',
                    'summary-general-title': 'Laburpen Orokorra',
                    'summary-total-repairs': 'Matxura Guztira',
                    'summary-total-cost': 'Kostu Totala',
                    'summary-by-class-title': 'Gelen Araberako Laburpena',
                    'summary-top-students-title': 'Matxura Gehien Dituzten 10 Ikasleak',
                    'summary-position': 'Posizioa',
                    'summary-student-name': 'Ikaslearen Izena',
                    'summary-repairs-count': 'Matxura Kopurua',
                    'summary-average-cost': 'Bataz Besteko Kostua',
                    'summary-generated-on': 'Sortze Data',
                    // Nuevas traducciones para la información del préstamo en PDF
                    'loaner-status-not-assigned': 'Ez da Chromebook mailegurik esleitu',
                    'label-loaner-id': 'Mailegu IDa',
                    'label-loaner-status': 'Mailegu Egoera',
                    // Nuevas traducciones para los informes totales
                    'report-total-by-class-title': 'Matxura Totalak Gelaren Arabera',
                    'report-total-by-student-title': 'Matxura Totalak Ikaslearen Arabera',
                    'label-total-class-start-date': 'Hasiera Data',
                    'label-total-class-end-date': 'Amaiera Data',
                    'label-total-student-start-date': 'Hasiera Data',
                    'label-total-student-end-date': 'Amaiera Data',
                    'generate-total-class-report-btn': 'Sortu Txostena',
                    'generate-total-student-report-btn': 'Sortu Txostena',
                    'total-class-report-title': 'Gelen Araberako Txosten Totala',
                    'total-student-report-title': 'Ikaslearen Araberako Txosten Totala',
                    'total-class-name': 'Gela',
                    'total-repairs-count': 'Matxura Guztira',
                    'total-student-name': 'Ikaslea',
                    'total-class-period': 'Periodoa',
                    'total-student-period': 'Periodoa',
                    // Nuevas traducciones para la sección de estadísticas
                    'stats-title': 'Estatistikak',
                    'monthly-stats-title': 'Hilabeteko Matxurak',
                    'class-stats-title': 'Gelen Araberako Matxurak',
                    'student-stats-title': 'Matxura Gehien Dituzten 5 Ikasleak',
                    // Traducción para el selector de curso escolar
                    'label-school-year': 'Ikasturtea:',
                    // Traducciones para la gestión de cursos académicos
                    'school-year-management-title': 'Ikasturteen Kudeaketa',
                    'school-year-name-label': 'Ikasturtearen Izena',
                    'school-year-start-date-label': 'Hasiera Data',
                    'school-year-end-date-label': 'Amaiera Data',
                    'add-school-year-btn': 'Gehitu Ikasturtea',
                    'delete-school-year-confirm': 'Ziur zaude ikasturte hau ezabatu nahi duzula?',
                    // Nuevas traducciones para la configuración de préstamo
                    'pdf-loaner-settings-title': 'Maileguaren Testuaren Konfigurazioa',
                    'label-pdf-loaner-text-es': 'Maileguaren Testua (Gaztelaniaz)',
                    'label-pdf-loaner-text-eus': 'Maileguaren Testua (Euskaraz)'
                }
            };
            const repairStatusOptions = {
                'pending': { text: 'status_pending', color: 'bg-yellow-100 text-yellow-800' },
                'in_progress': { text: 'status_in_progress', color: 'bg-blue-100 text-blue-800' },
                'repaired': { text: 'status_repaired', color: 'bg-green-100 text-green-800' },
                'unrepairable': { text: 'status_unrepairable', color: 'bg-red-100 text-red-800' }
            };
            const loanerStatusOptions = {
                'available': { text: 'status_loaner_available', color: 'bg-green-100 text-green-800' },
                'assigned': { text: 'status_loaner_assigned', color: 'bg-yellow-100 text-yellow-800' },
                'maintenance': { text: 'status_loaner_maintenance', color: 'bg-gray-100 text-gray-800' }
            };
            // --- DOM ELEMENTS ---
            const appNameHeader = document.getElementById('app-name-header');
            const appDescriptionHeader = document.getElementById('app-description-header');
            const appLogoHeader = document.getElementById('app-logo-header');
            const repairsTableBody = document.getElementById('repairs-table-body');
            const loanerTableBody = document.getElementById('loaner-table-body');
            const noResultsP = document.getElementById('no-results-p');
            const noLoanerResultsP = document.getElementById('no-loaner-results-p');
            const searchInput = document.getElementById('search-input');
            const statusFilter = document.getElementById('status-filter');
            const addRepairBtn = document.getElementById('add-repair-btn');
            const deleteSelectedRepairsBtn = document.getElementById('delete-selected-repairs-btn');
            const selectAllRepairsCheckbox = document.getElementById('select-all-repairs');
            
            // Elementos de paginación
            const paginationControls = document.getElementById('pagination-controls');
            const paginationInfoText = document.getElementById('pagination-info-text');
            const pageSizeSelect = document.getElementById('page-size-select');
            
            // KPIs
            const totalChromebooksEl = document.getElementById('total-chromebooks');
            const pendingRepairsEl = document.getElementById('pending-repairs');
            const inProgressRepairsEl = document.getElementById('in-progress-repairs');
            const repairedMonthEl = document.getElementById('repaired-month');
            const availableLoanersEl = document.getElementById('available-loaners');
            
            // Stats Section
            const statsTitle = document.getElementById('stats-title');
            const monthlyStatsTitle = document.getElementById('monthly-stats-title');
            const classStatsTitle = document.getElementById('class-stats-title');
            const studentStatsTitle = document.getElementById('student-stats-title');
            
            // Selector de curso escolar
            const schoolYearSelect = document.getElementById('school-year-select');
            
            // Repair Modal
            const repairModal = document.getElementById('repair-modal');
            const modalTitle = document.getElementById('modal-title');
            const closeModalBtn = document.getElementById('close-modal-btn');
            const repairForm = document.getElementById('repair-form');
            const repairIdInput = document.getElementById('repair-id');
            const repairStudentNameInput = document.getElementById('repair-student-name');
            const studentNameSuggestions = document.getElementById('student-name-suggestions');
            const repairClassNameInput = document.getElementById('repair-class-name');
            const repairSerialNumberInput = document.getElementById('repair-serial-number'); // Nuevo campo para número de serie
            const repairDescriptionInput = document.getElementById('repair-description');
            const repairStatusInput = document.getElementById('repair-status');
            const repairReportedDateInput = document.getElementById('repair-reported-date');
            const repairNotesInput = document.getElementById('repair-notes');
            const notesHistoryDiv = document.getElementById('notes-history');
            const saveRepairBtn = document.getElementById('save-repair-btn');
            const hasCostCheckbox = document.getElementById('has-cost-checkbox');
            const costAmountSection = document.getElementById('cost-amount-section');
            const costAmountInput = document.getElementById('cost-amount');
            
            // Elementos para la sección de préstamo
            const loanerSection = document.querySelector('.loaner-section');
            const loanerSelect = document.getElementById('loaner-select');
            const loanerReturnDateInput = document.getElementById('loaner-return-date');
            const loanerStatusBadge = document.getElementById('loaner-status-badge');
            const assignLoanerBtn = document.getElementById('assign-loaner-btn');
            const unassignLoanerBtn = document.getElementById('unassign-loaner-btn');
            
            // Photo/Camera elements
            const mainPhotoPreviewContainer = document.getElementById('photo-preview-container-main');
            const mainPhotoPreview = document.getElementById('main-photo-preview');
            const cameraFeed = document.getElementById('camera-feed');
            const photoPlaceholder = document.getElementById('photo-placeholder');
            const photoThumbnailsContainer = document.getElementById('photo-thumbnails-container');
            const photoUploadInput = document.getElementById('photo-upload');
            const uploadPhotoBtn = document.getElementById('upload-photo-btn');
            const capturePhotoBtn = document.getElementById('capture-photo-btn');
            const takePictureBtn = document.getElementById('take-picture-btn');
            
            // Config Modal
            const configBtn = document.getElementById('config-btn');
            const configModal = document.getElementById('config-modal');
            const closeConfigBtn = document.getElementById('close-config-btn');
            const configForm = document.getElementById('config-form');
            const appNameInput = document.getElementById('app-name');
            const appDescriptionInput = document.getElementById('app-description');
            const appLogoInput = document.getElementById('app-logo');
            const logoPreview = document.getElementById('logo-preview');
            const languageSelector = document.getElementById('language-selector');
            const contactEmailInput = document.getElementById('contact-email');
            const exportBtn = document.getElementById('export-btn');
            const exportCsvBtn = document.getElementById('export-csv-btn');
            const importFileInput = document.getElementById('import-file');
            const deleteAllDataBtn = document.getElementById('delete-all-data-btn');
            const classGroupsList = document.getElementById('class-groups-list');
            const newClassGroupInput = document.getElementById('new-class-group-input');
            const addClassGroupForm = document.getElementById('add-class-group-form');
            
            // PDF Config Form
            const pdfConfigForm = document.getElementById('pdf-config-form');
            const pdfHeaderTitleInput = document.getElementById('pdf-header-title');
            const pdfHeaderSubtitleInput = document.getElementById('pdf-header-subtitle');
            const pdfFooterLeftInput = document.getElementById('pdf-footer-left');
            const pdfFooterRightInput = document.getElementById('pdf-footer-right');
            const pdfAgreementTextEsInput = document.getElementById('pdf-agreement-text-es');
            const pdfAgreementTextEusInput = document.getElementById('pdf-agreement-text-eus');
            const pdfSignatureTextEsInput = document.getElementById('pdf-signature-text-es');
            const pdfSignatureTextEusInput = document.getElementById('pdf-signature-text-eus');
            const savePdfConfigBtn = document.getElementById('save-pdf-config-btn');
            
            // School Year Management
            const addSchoolYearForm = document.getElementById('add-school-year-form');
            const schoolYearNameInput = document.getElementById('school-year-name');
            const schoolYearStartDateInput = document.getElementById('school-year-start-date');
            const schoolYearEndDateInput = document.getElementById('school-year-end-date');
            const schoolYearsList = document.getElementById('school-years-list');
            
            // Loaner Modal
            const addLoanerBtn = document.getElementById('add-loaner-btn');
            const loanerModal = document.getElementById('loaner-modal');
            const closeLoanerModalBtn = document.getElementById('close-loaner-modal-btn');
            const loanerForm = document.getElementById('loaner-form');
            const loanerModalTitle = document.getElementById('loaner-modal-title');
            const loanerIdInput = document.getElementById('loaner-id');
            const loanerStatusSelect = document.getElementById('loaner-status');
            const loanerAssignedToSection = document.getElementById('loaner-assigned-to-section');
            const loanerAssignedToInput = document.getElementById('loaner-assigned-to');
            
            // Reports Modal
            const reportsBtn = document.getElementById('reports-btn');
            const reportsModal = document.getElementById('reports-modal');
            const closeReportsBtn = document.getElementById('close-reports-btn');
            const reportStatusFilter = document.getElementById('report-status-filter');
            const sumCostCheckbox = document.getElementById('sum-cost-checkbox');
            const generateStatusReportBtn = document.getElementById('generate-status-report-btn');
            const reportStudentNameInput = document.getElementById('report-student-name');
            const reportStudentSuggestions = document.getElementById('report-student-suggestions');
            const reportStudentStartDate = document.getElementById('report-student-start-date');
            const reportStudentEndDate = document.getElementById('report-student-end-date');
            const generateStudentReportBtn = document.getElementById('generate-student-report-btn');
            const reportClassFilter = document.getElementById('report-class-filter');
            const generateClassReportBtn = document.getElementById('generate-class-report-btn');
            const reportClassStartDate = document.getElementById('report-class-start-date');
            const reportClassEndDate = document.getElementById('report-class-end-date');
            
            // Summary Report Elements
            const summaryStartDate = document.getElementById('summary-start-date');
            const summaryEndDate = document.getElementById('summary-end-date');
            const generateSummaryReportBtn = document.getElementById('generate-summary-report-btn');
            
            // Total Reports Elements
            const totalClassStartDate = document.getElementById('total-class-start-date');
            const totalClassEndDate = document.getElementById('total-class-end-date');
            const generateTotalClassReportBtn = document.getElementById('generate-total-class-report-btn');
            const totalStudentStartDate = document.getElementById('total-student-start-date');
            const totalStudentEndDate = document.getElementById('total-student-end-date');
            const generateTotalStudentReportBtn = document.getElementById('generate-total-student-report-btn');
            
            // Language Selector in Header
            const headerLanguageBtn = document.getElementById('header-language-btn');
            const headerLanguageDropdown = document.getElementById('header-language-dropdown');
            const currentLanguageFlag = document.getElementById('current-language-flag');
            const currentLanguageText = document.getElementById('current-language-text');
            
            // --- UTILITY FUNCTIONS ---
            const saveState = () => {
                localStorage.setItem('repairs', JSON.stringify(repairs));
                localStorage.setItem('loanerChromebooks', JSON.stringify(loanerChromebooks));
                localStorage.setItem('config', JSON.stringify(config));
            };
            const translateText = (key) => {
                return translations[config.language][key] || key;
            };
            const formatDate = (dateString) => {
                if (!dateString) return '';
                const date = new Date(dateString);
                return date.toLocaleDateString(config.language === 'eus' ? 'eu-ES' : 'es-ES');
            };
            const formatDateTime = (dateString) => {
                if (!dateString) return '';
                const date = new Date(dateString);
                return date.toLocaleString(config.language === 'eus' ? 'eu-ES' : 'es-ES');
            };
            
            // --- FUNCIÓN PARA OBTENER NOMBRE DE ALUMNO A PARTIR DE ID DE AVERÍA ---
            const getStudentNameFromRepairId = (repairId) => {
                if (!repairId) return '';
                const repair = repairs.find(r => r.id === repairId);
                return repair ? repair.studentName : '';
            };
            
            // --- FUNCIÓN PARA ACTUALIZAR LA INFORMACIÓN DE PAGINACIÓN ---
            const updatePaginationInfo = () => {
                const totalItems = filteredRepairs.length;
                const totalPages = Math.ceil(totalItems / pageSize);
                const startItem = (currentPage - 1) * pageSize + 1;
                const endItem = Math.min(currentPage * pageSize, totalItems);
                
                if (paginationInfoText) {
                    paginationInfoText.textContent = `Mostrando ${startItem}-${endItem} de ${totalItems} resultados`;
                }
            };
            
            // --- FUNCIÓN PARA RENDERIZAR LOS CONTROLES DE PAGINACIÓN ---
            const renderPaginationControls = () => {
                if (!paginationControls) return;
                
                const totalItems = filteredRepairs.length;
                const totalPages = Math.ceil(totalItems / pageSize);
                
                // Limpiar controles existentes
                paginationControls.innerHTML = '';
                
                // Botón "Anterior"
                const prevBtn = document.createElement('button');
                prevBtn.className = 'pagination-btn';
                prevBtn.textContent = 'Anterior';
                prevBtn.disabled = currentPage === 1;
                prevBtn.addEventListener('click', () => {
                    if (currentPage > 1) {
                        currentPage--;
                        renderTable();
                    }
                });
                paginationControls.appendChild(prevBtn);
                
                // Números de página
                const maxVisiblePages = 5;
                let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
                let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
                
                if (endPage - startPage + 1 < maxVisiblePages) {
                    startPage = Math.max(1, endPage - maxVisiblePages + 1);
                }
                
                if (startPage > 1) {
                    const firstPageBtn = document.createElement('button');
                    firstPageBtn.className = 'pagination-btn';
                    firstPageBtn.textContent = '1';
                    firstPageBtn.addEventListener('click', () => {
                        currentPage = 1;
                        renderTable();
                    });
                    paginationControls.appendChild(firstPageBtn);
                    
                    if (startPage > 2) {
                        const ellipsis = document.createElement('span');
                        ellipsis.textContent = '...';
                        ellipsis.className = 'px-2';
                        paginationControls.appendChild(ellipsis);
                    }
                }
                
                for (let i = startPage; i <= endPage; i++) {
                    const pageBtn = document.createElement('button');
                    pageBtn.className = `pagination-btn ${i === currentPage ? 'active' : ''}`;
                    pageBtn.textContent = i;
                    pageBtn.addEventListener('click', () => {
                        currentPage = i;
                        renderTable();
                    });
                    paginationControls.appendChild(pageBtn);
                }
                
                if (endPage < totalPages) {
                    if (endPage < totalPages - 1) {
                        const ellipsis = document.createElement('span');
                        ellipsis.textContent = '...';
                        ellipsis.className = 'px-2';
                        paginationControls.appendChild(ellipsis);
                    }
                    
                    const lastPageBtn = document.createElement('button');
                    lastPageBtn.className = 'pagination-btn';
                    lastPageBtn.textContent = totalPages;
                    lastPageBtn.addEventListener('click', () => {
                        currentPage = totalPages;
                        renderTable();
                    });
                    paginationControls.appendChild(lastPageBtn);
                }
                
                // Botón "Siguiente"
                const nextBtn = document.createElement('button');
                nextBtn.className = 'pagination-btn';
                nextBtn.textContent = 'Siguiente';
                nextBtn.disabled = currentPage === totalPages || totalPages === 0;
                nextBtn.addEventListener('click', () => {
                    if (currentPage < totalPages) {
                        currentPage++;
                        renderTable();
                    }
                });
                paginationControls.appendChild(nextBtn);
            };
            
            // --- TRANSLATION & UI UPDATE FUNCTION ---
            const applyTranslations = () => {
                // Main Headers
                if (appNameHeader) appNameHeader.textContent = config.appName;
                if (appDescriptionHeader) appDescriptionHeader.textContent = config.appDescription;
                
                // Update language selector in header
                if (config.language === 'es') {
                    currentLanguageFlag.textContent = '🇪🇸';
                    currentLanguageText.textContent = 'Español';
                } else {
                    currentLanguageFlag.textContent = '🇪🇺';
                    currentLanguageText.textContent = 'Euskara';
                }
                
                // Stats section titles
                if (statsTitle) statsTitle.textContent = translateText('stats-title');
                if (monthlyStatsTitle) monthlyStatsTitle.textContent = translateText('monthly-stats-title');
                if (classStatsTitle) classStatsTitle.textContent = translateText('class-stats-title');
                if (studentStatsTitle) studentStatsTitle.textContent = translateText('student-stats-title');
                
                // Label for school year selector
                const schoolYearLabel = document.getElementById('label-school-year');
                if (schoolYearLabel) schoolYearLabel.textContent = translateText('label-school-year');
                
                // Buttons and Titles
                const elementsToTranslate = {
                    'reports-btn': 'reports-btn', 'config-btn': 'config-btn',
                    'kpi-total-chromebooks-label': 'kpi-total-chromebooks-label', 'kpi-pending-repairs-label': 'kpi-pending-repairs-label',
                    'kpi-in-progress-repairs-label': 'kpi-in-progress-repairs-label', 'kpi-repaired-month-label': 'kpi-repaired-month-label',
                    'kpi-available-loaners-label': 'kpi-available-loaners-label', 'repairs-list-title': 'repairs-list-title',
                    'add-repair-btn': 'add-repair-btn', 'delete-selected-repairs-btn': 'delete-selected-repairs-btn',
                    'table-header-student': 'table-header-student', 'table-header-class': 'table-header-class',
                    'table-header-status': 'table-header-status', 'table-header-reported-date': 'table-header-reported-date',
                    'table-header-repaired-date': 'table-header-repaired-date', 'table-header-actions': 'table-header-actions',
                    'no-results-p': 'no-results-p', 'status-chart-title': 'status-chart-title',
                    'loaner-management-title': 'loaner-management-title', 'add-loaner-btn': 'add-loaner-btn',
                    'loaner-table-header-id': 'loaner-table-header-id', 'loaner-table-header-status': 'loaner-table-header-status',
                    'loaner-table-header-assigned-to': 'loaner-table-header-assigned-to', 'loaner-table-header-actions': 'loaner-table-header-actions',
                    'no-loaner-results-p': 'no-loaner-results-p',
                    'label-repair-student-name': 'label-repair-student-name', 'label-repair-class-name': 'label-repair-class-name',
                    'label-repair-description': 'label-repair-description', 'label-repair-status': 'label-repair-status',
                    'label-repair-reported-date': 'label-repair-reported-date', 'label-repair-notes': 'label-repair-notes',
                    'label-photo-section': 'label-photo-section', 'photo-placeholder': 'photo-placeholder',
                    'upload-photo-btn': 'upload-photo-btn', 'capture-photo-btn': 'capture-photo-btn', 'take-picture-btn': 'take-picture-btn',
                    'label-has-cost': 'label-has-cost', 'label-cost-amount': 'label-cost-amount',
                    'save-repair-btn': 'save-repair-btn', 'config-modal-title': 'config-modal-title',
                    'label-app-name': 'label-app-name', 'label-app-description': 'label-app-description',
                    'label-app-logo': 'label-app-logo', 'label-language-selector': 'label-language-selector',
                    'label-contact-email': 'label-contact-email',
                    'save-config-btn': 'save-config-btn', 'add-class-group-btn': 'add-class-group-btn',
                    'import-data-title': 'import-data-title', 'import-data-desc': 'import-data-desc',
                    'export-data-title': 'export-data-title', 'export-data-desc': 'export-data-desc',
                    'export-btn': 'export-btn', 'export-csv-btn': 'export-csv-btn',
                    'delete-data-title': 'delete-data-title',
                    'delete-data-desc': 'delete-data-desc', 'delete-all-data-btn': 'delete-all-data-btn',
                    'loaner-modal-title': 'loaner-modal-title', 'label-loaner-id': 'label-loaner-id',
                    'label-loaner-status': 'label-loaner-status', 'label-loaner-assigned-to': 'label-loaner-assigned-to',
                    'save-loaner-btn': 'save-loaner-btn', 'reports-modal-title': 'reports-modal-title',
                    'report-by-status-title': 'report-by-status-title', 'report-by-class-title': 'report-by-class-title',
                    'generate-class-report-btn': 'generate-class-report-btn', 'label-sum-cost': 'label-sum-cost',
                    'generate-status-report-btn': 'generate-status-report-btn', 'report-by-student-title': 'report-by-student-title',
                    'label-report-student-name': 'label-report-student-name', 'label-report-start-date': 'label-report-start-date',
                    'label-report-end-date': 'label-report-end-date', 'generate-student-report-btn': 'generate-student-report-btn',
                    'label-report-class-filter': 'label-report-class-filter', 'label-report-class-start-date': 'label-report-class-start-date',
                    'label-report-class-end-date': 'label-report-class-end-date',
                    // Nuevas traducciones para la sección de préstamo
                    'label-loaner-section': 'label-loaner-section', 'label-loaner-select': 'label-loaner-select',
                    'label-loaner-return-date': 'label-loaner-return-date', 'assign-loaner-btn': 'assign-loaner-btn',
                    'unassign-loaner-btn': 'unassign-loaner-btn',
                    // Traducciones para la configuración de PDFs
                    'pdf-header-settings-title': 'pdf-header-settings-title',
                    'label-pdf-header-title': 'label-pdf-header-title',
                    'label-pdf-header-subtitle': 'label-pdf-header-subtitle',
                    'pdf-footer-settings-title': 'pdf-footer-settings-title',
                    'label-pdf-footer-left': 'label-pdf-footer-left',
                    'label-pdf-footer-right': 'label-pdf-footer-right',
                    'pdf-agreement-settings-title': 'pdf-agreement-settings-title',
                    'label-pdf-agreement-text-es': 'label-pdf-agreement-text-es',
                    'label-pdf-agreement-text-eus': 'label-pdf-agreement-text-eus',
                    'pdf-signature-settings-title': 'pdf-signature-settings-title',
                    'label-pdf-signature-text-es': 'label-pdf-signature-text-es',
                    'label-pdf-signature-text-eus': 'label-pdf-signature-text-eus',
                    'save-pdf-config-btn': 'save-pdf-config-btn',
                    // Nuevas traducciones para el informe resumen
                    'report-summary-title': 'report-summary-title',
                    'label-summary-start-date': 'label-summary-start-date',
                    'label-summary-end-date': 'label-summary-end-date',
                    'generate-summary-report-btn': 'generate-summary-report-btn',
                    // Nuevas traducciones para los informes totales
                    'report-total-by-class-title': 'report-total-by-class-title',
                    'report-total-by-student-title': 'report-total-by-student-title',
                    'label-total-class-start-date': 'label-total-class-start-date',
                    'label-total-class-end-date': 'label-total-class-end-date',
                    'label-total-student-start-date': 'label-total-student-start-date',
                    'label-total-student-end-date': 'label-total-student-end-date',
                    'generate-total-class-report-btn': 'generate-total-class-report-btn',
                    'generate-total-student-report-btn': 'generate-total-student-report-btn',
                    '[data-tab="general-settings"]': 'tab-general-settings', 
                    '[data-tab="class-management"]': 'tab-class-management',
                    '[data-tab="school-year-management"]': 'tab-school-year-management',
                    '[data-tab="data-management"]': 'tab-data-management',
                    '[data-tab="pdf-settings"]': 'tab-pdf-settings'
                };
                for (const selector in elementsToTranslate) {
                    const element = document.querySelector(selector.startsWith('[') ? selector : `#${selector}`);
                    if (element) {
                        element.textContent = translateText(elementsToTranslate[selector]);
                    }
                }
                
                // Placeholders
                if (searchInput) searchInput.placeholder = translateText('search-input-placeholder');
                if (newClassGroupInput) newClassGroupInput.placeholder = translateText('new-class-group-input-placeholder');
                
                // Populate dropdowns
                populateStatusFilter();
                populateRepairStatusDropdown();
                populateLoanerStatusDropdown();
                populateReportStatusFilter();
                populateReportClassFilter();
            };
            // --- RENDER FUNCTIONS ---
            const renderTable = () => {
                if (!repairsTableBody) return;
                
                // Aplicar filtros
                const filterValue = statusFilter.value;
                const searchValue = searchInput.value.toLowerCase();
                filteredRepairs = repairs.filter(repair => {
                    const matchesStatus = filterValue === 'all' || repair.status === filterValue;
                    const matchesSearch = !searchValue ||
                        repair.id.toLowerCase().includes(searchValue) ||
                        repair.studentName.toLowerCase().includes(searchValue) ||
                        repair.className.toLowerCase().includes(searchValue) ||
                        (repair.serialNumber && repair.serialNumber.toLowerCase().includes(searchValue)); // Búsqueda por número de serie
                    return matchesStatus && matchesSearch;
                });
                
                // Resetear a la primera página cuando cambian los filtros
                currentPage = 1;
                
                // Ordenar
                filteredRepairs.sort((a, b) => {
                    const valA = a[currentSort.column];
                    const valB = b[currentSort.column];
                    
                    let comparison = 0;
                    if (valA > valB) {
                        comparison = 1;
                    } else if (valA < valB) {
                        comparison = -1;
                    }
                    return currentSort.order === 'asc' ? comparison : -comparison;
                });
                
                // Calcular paginación
                const totalPages = Math.ceil(filteredRepairs.length / pageSize);
                const startIndex = (currentPage - 1) * pageSize;
                const endIndex = Math.min(startIndex + pageSize, filteredRepairs.length);
                const paginatedRepairs = filteredRepairs.slice(startIndex, endIndex);
                
                // Renderizar tabla
                repairsTableBody.innerHTML = '';
                if (paginatedRepairs.length === 0) {
                    if (noResultsP) noResultsP.classList.remove('hidden');
                } else {
                    if (noResultsP) noResultsP.classList.add('hidden');
                    paginatedRepairs.forEach(repair => {
                        const row = document.createElement('tr');
                        row.className = 'bg-white border-b hover:bg-stone-50';
                        const statusInfo = repairStatusOptions[repair.status] || { text: repair.status, color: 'bg-gray-100 text-gray-800' };
                        
                        row.innerHTML = `
                            <td class="w-4 p-4">
                                <div class="flex items-center">
                                    <input type="checkbox" data-id="${repair.id}" class="repair-checkbox w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500">
                                    <label for="checkbox-table-search-1" class="sr-only">checkbox</label>
                                </div>
                            </td>
                            <td class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap">${repair.id}</td>
                            <td class="px-6 py-4">${repair.studentName}</td>
                            <td class="px-6 py-4">${repair.className}</td>
                            <td class="px-6 py-4">${repair.serialNumber || '---'}</td>
                            <td class="px-6 py-4">
                                <span class="text-xs font-medium mr-2 px-2.5 py-0.5 rounded-full ${statusInfo.color}">${translateText(statusInfo.text)}</span>
                            </td>
                            <td class="px-6 py-4">${formatDate(repair.reportedDate)}</td>
                            <td class="px-6 py-4">${repair.status === 'repaired' ? formatDate(repair.repairedDate) : '---'}</td>
                            <td class="px-6 py-4 flex items-center space-x-2">
                                <button data-id="${repair.id}" class="edit-btn text-blue-600 hover:text-blue-800 font-medium">✏️</button>
                                <button data-id="${repair.id}" class="delete-btn text-red-600 hover:text-red-800 font-medium">🗑️</button>
                                <button data-id="${repair.id}" class="pdf-btn text-gray-600 hover:text-gray-800 font-medium">📄</button>
                            </td>
                        `;
                        repairsTableBody.appendChild(row);
                    });
                }
                
                // Actualizar información de paginación
                updatePaginationInfo();
                renderPaginationControls();
                
                updateKPIs();
                updateDeleteSelectedButtonVisibility();
            };
            
            const renderLoanerTable = () => {
                if (!loanerTableBody) return;
                loanerTableBody.innerHTML = '';
                if (loanerChromebooks.length === 0) {
                   if (noLoanerResultsP) noLoanerResultsP.classList.remove('hidden');
                } else {
                   if (noLoanerResultsP) noLoanerResultsP.classList.add('hidden');
                    loanerChromebooks.forEach(loaner => {
                        const row = document.createElement('tr');
                        row.className = 'bg-white border-b hover:bg-stone-50';
                        const statusInfo = loanerStatusOptions[loaner.status] || { text: loaner.status, color: 'bg-gray-100 text-gray-800' };
                        
                        // Obtener el nombre del alumno asignado
                        const assignedStudentName = getStudentNameFromRepairId(loaner.assignedTo);
                        
                        row.innerHTML = `
                            <td class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap">${loaner.id}</td>
                            <td class="px-6 py-4">
                                <span class="text-xs font-medium mr-2 px-2.5 py-0.5 rounded-full ${statusInfo.color}">${translateText(statusInfo.text)}</span>
                            </td>
                            <td class="px-6 py-4">${assignedStudentName || '---'}</td>
                            <td class="px-6 py-4 flex items-center space-x-2">
                                <button data-id="${loaner.id}" class="edit-loaner-btn text-blue-600 hover:text-blue-800 font-medium">✏️</button>
                                <button data-id="${loaner.id}" class="delete-loaner-btn text-red-600 hover:text-red-800 font-medium">🗑️</button>
                            </td>
                        `;
                        loanerTableBody.appendChild(row);
                    });
                }
                updateKPIs();
            };
            const updateKPIs = () => {
                const now = new Date();
                const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                const pendingCount = repairs.filter(r => r.status === 'pending').length;
                const inProgressCount = repairs.filter(r => r.status === 'in_progress').length;
                const repairedThisMonthCount = repairs.filter(r => {
                    const repairedDate = new Date(r.repairedDate);
                    return r.status === 'repaired' && repairedDate >= startOfMonth;
                }).length;
                const availableLoanersCount = loanerChromebooks.filter(l => l.status === 'available').length;
                if (totalChromebooksEl) totalChromebooksEl.textContent = repairs.length;
                if (pendingRepairsEl) pendingRepairsEl.textContent = pendingCount;
                if (inProgressRepairsEl) inProgressRepairsEl.textContent = inProgressCount;
                if (repairedMonthEl) repairedMonthEl.textContent = repairedThisMonthCount;
                if (availableLoanersEl) availableLoanersEl.textContent = availableLoanersCount;
            };
            const renderChart = () => {
                const ctx = document.getElementById('repairs-chart')?.getContext('2d');
                if (!ctx) return;
                const statusCounts = repairs.reduce((acc, repair) => {
                    acc[repair.status] = (acc[repair.status] || 0) + 1;
                    return acc;
                }, {});
                const labels = Object.keys(statusCounts).map(status => translateText(repairStatusOptions[status]?.text || status));
                const data = Object.values(statusCounts);
                const backgroundColors = Object.keys(statusCounts).map(status => {
                    switch(status) {
                        case 'pending': return '#FBBF24'; // amber-400
                        case 'in_progress': return '#60A5FA'; // blue-400
                        case 'repaired': return '#34D399'; // green-400
                        case 'unrepairable': return '#F87171'; // red-400
                        default: return '#D1D5DB'; // gray-300
                    }
                });
                if (repairsChart) {
                    repairsChart.destroy();
                }
                Chart.register(ChartDataLabels);
                repairsChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: translateText('repairs-list-title'),
                            data: data,
                            backgroundColor: backgroundColors,
                            borderColor: '#ffffff',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            datalabels: {
                                formatter: (value, ctx) => {
                                    return value;
                                },
                                color: '#fff',
                                font: {
                                    weight: 'bold',
                                    size: 14,
                                }
                            }
                        }
                    }
                });
            };
            
            // --- STATS CHARTS ---
            const renderMonthlyChart = () => {
                const ctx = document.getElementById('monthly-chart')?.getContext('2d');
                if (!ctx) return;
                
                // Filtrar reparaciones por el curso escolar seleccionado
                const filteredRepairs = filterRepairsBySchoolYear(repairs, selectedSchoolYear);
                
                // Get months for the selected school year
                const schoolYearDates = getSchoolYearDates(selectedSchoolYear);
                const startYear = schoolYearDates.startDate.getFullYear();
                const endYear = schoolYearDates.endDate.getFullYear();
                
                // Crear array de meses para el curso escolar (septiembre a julio)
                const months = [];
                const monthCounts = [];
                
                // Añadir meses del primer año (septiembre a diciembre)
                for (let month = 8; month <= 11; month++) {
                    const monthName = new Date(startYear, month).toLocaleDateString(config.language === 'eus' ? 'eu-ES' : 'es-ES', { month: 'short', year: 'numeric' });
                    months.push(monthName);
                    
                    const monthStart = new Date(startYear, month, 1);
                    const monthEnd = new Date(startYear, month + 1, 0);
                    
                    const count = filteredRepairs.filter(repair => {
                        const repairDate = new Date(repair.reportedDate);
                        return repairDate >= monthStart && repairDate <= monthEnd;
                    }).length;
                    
                    monthCounts.push(count);
                }
                
                // Añadir meses del segundo año (enero a julio)
                for (let month = 0; month <= 6; month++) {
                    const monthName = new Date(endYear, month).toLocaleDateString(config.language === 'eus' ? 'eu-ES' : 'es-ES', { month: 'short', year: 'numeric' });
                    months.push(monthName);
                    
                    const monthStart = new Date(endYear, month, 1);
                    const monthEnd = new Date(endYear, month + 1, 0);
                    
                    const count = filteredRepairs.filter(repair => {
                        const repairDate = new Date(repair.reportedDate);
                        return repairDate >= monthStart && repairDate <= monthEnd;
                    }).length;
                    
                    monthCounts.push(count);
                }
                
                if (monthlyChart) {
                    monthlyChart.destroy();
                }
                
                monthlyChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: months,
                        datasets: [{
                            label: translateText('monthly-stats-title'),
                            data: monthCounts,
                            backgroundColor: '#3B82F6',
                            borderColor: '#2563EB',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });
            };
            
            const renderClassChart = () => {
                const ctx = document.getElementById('class-chart')?.getContext('2d');
                if (!ctx) return;
                
                // Filtrar reparaciones por el curso escolar seleccionado
                const filteredRepairs = filterRepairsBySchoolYear(repairs, selectedSchoolYear);
                
                // Count repairs by class
                const classCounts = {};
                filteredRepairs.forEach(repair => {
                    if (!classCounts[repair.className]) {
                        classCounts[repair.className] = 0;
                    }
                    classCounts[repair.className]++;
                });
                
                const labels = Object.keys(classCounts);
                const data = Object.values(classCounts);
                
                // Generate colors
                const backgroundColors = labels.map((_, index) => {
                    const hue = (index * 360) / labels.length;
                    return `hsl(${hue}, 70%, 60%)`;
                });
                
                if (classChart) {
                    classChart.destroy();
                }
                
                classChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: translateText('class-stats-title'),
                            data: data,
                            backgroundColor: backgroundColors,
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });
            };
            
            const renderStudentsChart = () => {
                const ctx = document.getElementById('students-chart')?.getContext('2d');
                if (!ctx) return;
                
                // Filtrar reparaciones por el curso escolar seleccionado
                const filteredRepairs = filterRepairsBySchoolYear(repairs, selectedSchoolYear);
                
                // Count repairs by student
                const studentCounts = {};
                filteredRepairs.forEach(repair => {
                    if (!studentCounts[repair.studentName]) {
                        studentCounts[repair.studentName] = 0;
                    }
                    studentCounts[repair.studentName]++;
                });
                
                // Sort by count and get top 5
                const sortedStudents = Object.entries(studentCounts)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5);
                
                const labels = sortedStudents.map(([name]) => name);
                const data = sortedStudents.map(([, count]) => count);
                
                // Generate colors
                const backgroundColors = labels.map((_, index) => {
                    const hue = (index * 360) / labels.length;
                    return `hsl(${hue}, 70%, 60%)`;
                });
                
                if (studentsChart) {
                    studentsChart.destroy();
                }
                
                studentsChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: translateText('student-stats-title'),
                            data: data,
                            backgroundColor: backgroundColors,
                            borderWidth: 1
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });
            };
            
            // Modificar la función renderClassGroups para permitir la edición
            const renderClassGroups = () => {
                if (!classGroupsList) return;
                classGroupsList.innerHTML = '';
                config.classGroups.forEach((group, index) => {
                    const row = document.createElement('div');
                    row.className = 'class-group-row flex items-center justify-between p-2 bg-stone-50 rounded-lg';
                    row.setAttribute('draggable', true);
                    row.dataset.index = index;
                    row.innerHTML = `
                        <div class="flex items-center space-x-2">
                            <span class="drag-handle cursor-move">☰</span>
                            <input type="text" value="${group}" class="class-name-input bg-transparent border-b border-transparent hover:border-gray-300 focus:border-blue-500 focus:outline-none px-1" data-original="${group}">
                        </div>
                        <div class="flex space-x-1">
                            <button data-group="${group}" class="save-class-group-btn text-green-500 hover:text-green-700">💾</button>
                            <button data-group="${group}" class="delete-class-group-btn text-red-500 hover:text-red-700">🗑️</button>
                        </div>
                    `;
                    classGroupsList.appendChild(row);
                });
            };
            
            // Función para renderizar la lista de cursos académicos
            const renderSchoolYears = () => {
                if (!schoolYearsList) return;
                
                schoolYearsList.innerHTML = '';
                
                if (config.schoolYears && config.schoolYears.length > 0) {
                    config.schoolYears.forEach((schoolYear, index) => {
                        const item = document.createElement('div');
                        item.className = 'school-year-item';
                        item.innerHTML = `
                            <div class="school-year-item-info">
                                <div class="school-year-item-name">${schoolYear.name}</div>
                                <div class="school-year-item-dates">${formatDate(schoolYear.startDate)} - ${formatDate(schoolYear.endDate)}</div>
                            </div>
                            <div class="school-year-item-actions">
                                <button data-index="${index}" class="delete-school-year-btn btn-small bg-red-500 hover:bg-red-700 text-white rounded">🗑️</button>
                            </div>
                        `;
                        schoolYearsList.appendChild(item);
                    });
                } else {
                    schoolYearsList.innerHTML = '<p class="text-slate-500">No hay cursos académicos definidos.</p>';
                }
            };
            
            // --- POPULATE DROPDOWNS ---
            const populateStatusFilter = () => {
                if (!statusFilter) return;
                statusFilter.innerHTML = `<option value="all">${translateText('filter_all')}</option>`;
                Object.keys(repairStatusOptions).forEach(key => {
                    statusFilter.innerHTML += `<option value="${key}">${translateText(repairStatusOptions[key].text)}</option>`;
                });
            };
            const populateRepairStatusDropdown = () => {
                if (!repairStatusInput) return;
                repairStatusInput.innerHTML = '';
                 Object.keys(repairStatusOptions).forEach(key => {
                    repairStatusInput.innerHTML += `<option value="${key}">${translateText(repairStatusOptions[key].text)}</option>`;
                });
            };
            const populateLoanerStatusDropdown = () => {
                if (!loanerStatusSelect) return;
                loanerStatusSelect.innerHTML = '';
                 Object.keys(loanerStatusOptions).forEach(key => {
                    loanerStatusSelect.innerHTML += `<option value="${key}">${translateText(loanerStatusOptions[key].text)}</option>`;
                });
            };
            const populateClassGroupDropdown = () => {
                if (!repairClassNameInput) return;
                repairClassNameInput.innerHTML = '';
                config.classGroups.forEach(group => {
                    repairClassNameInput.innerHTML += `<option value="${group}">${group}</option>`;
                });
            };
            const populateLoanerAssignmentDropdown = () => {
                if (!loanerAssignedToInput) return;
                loanerAssignedToInput.innerHTML = `<option value="">---</option>`;
                const assignableRepairs = repairs.filter(r => r.status === 'pending' || r.status === 'in_progress');
                assignableRepairs.forEach(r => {
                    loanerAssignedToInput.innerHTML += `<option value="${r.id}">${r.id} - ${r.studentName}</option>`;
                });
            };
            const populateReportStatusFilter = () => {
                if (!reportStatusFilter) return;
                reportStatusFilter.innerHTML = '';
                Object.keys(repairStatusOptions).forEach(key => {
                    reportStatusFilter.innerHTML += `<option value="${key}">${translateText(repairStatusOptions[key].text)}</option>`;
                });
            };
            const populateReportClassFilter = () => {
                if (!reportClassFilter) return;
                reportClassFilter.innerHTML = '';
                config.classGroups.forEach(group => {
                    reportClassFilter.innerHTML += `<option value="${group}">${group}</option>`;
                });
            };
            
            // --- POBLAR SELECTOR DE CURSOS ESCOLARES ---
            const populateSchoolYearSelect = () => {
                if (!schoolYearSelect) return;
                
                const schoolYears = getAvailableSchoolYears(5); // Obtener los últimos 5 cursos
                schoolYearSelect.innerHTML = '';
                
                schoolYears.forEach(year => {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    if (year === selectedSchoolYear) {
                        option.selected = true;
                    }
                    schoolYearSelect.appendChild(option);
                });
                
                // Añadir event listener para el cambio de curso
                schoolYearSelect.addEventListener('change', (e) => {
                    selectedSchoolYear = e.target.value;
                    renderMonthlyChart();
                    renderClassChart();
                    renderStudentsChart();
                });
            };
            
            // --- POBLAR SELECTOR DE PRÉSTAMOS ---
            const populateLoanerSelect = () => {
                if (!loanerSelect) return;
                loanerSelect.innerHTML = '<option value="">-- Seleccionar Chromebook de préstamo --</option>';
                
                // Añadir Chromebooks disponibles
                loanerChromebooks.filter(loaner => loaner.status === 'available').forEach(loaner => {
                    const option = document.createElement('option');
                    option.value = loaner.id;
                    option.textContent = loaner.id;
                    loanerSelect.appendChild(option);
                });
                
                // Si estamos editando una avería con un préstamo asignado, añadirlo también
                if (editingRepairId) {
                    const repair = repairs.find(r => r.id === editingRepairId);
                    if (repair && repair.loanerChromebook) {
                        const loaner = loanerChromebooks.find(l => l.id === repair.loanerChromebook);
                        if (loaner) {
                            // Comprobar si ya está en la lista
                            let option = loanerSelect.querySelector(`option[value="${loaner.id}"]`);
                            if (!option) {
                                option = document.createElement('option');
                                option.value = loaner.id;
                                option.textContent = `${loaner.id} (${translateText('status_loaner_assigned')})`;
                                loanerSelect.appendChild(option);
                            }
                            loanerSelect.value = loaner.id;
                            
                            // Mostrar fecha de devolución si existe
                            if (loaner.returnDate) {
                                loanerReturnDateInput.value = loaner.returnDate;
                            }
                            
                            // Actualizar estado visual
                            updateLoanerStatusBadge(true);
                        }
                    }
                }
            };
            
            // --- ACTUALIZAR ESTADO VISUAL DEL PRÉSTAMO ---
            const updateLoanerStatusBadge = (isAssigned) => {
                if (!loanerStatusBadge) return;
                
                if (isAssigned) {
                    loanerStatusBadge.textContent = translateText('loaner-status-assigned');
                    loanerStatusBadge.className = 'loaner-status-badge assigned';
                    assignLoanerBtn.classList.add('hidden');
                    unassignLoanerBtn.classList.remove('hidden');
                } else {
                    loanerStatusBadge.textContent = translateText('loaner-status-not-assigned');
                    loanerStatusBadge.className = 'loaner-status-badge available';
                    assignLoanerBtn.classList.remove('hidden');
                    unassignLoanerBtn.classList.add('hidden');
                }
            };
            
            // --- ASIGNAR PRÉSTAMO ---
            const assignLoaner = () => {
                const selectedLoanerId = loanerSelect.value;
                if (!selectedLoanerId) {
                    alert('Por favor, selecciona un Chromebook de préstamo');
                    return;
                }
                
                const loaner = loanerChromebooks.find(l => l.id === selectedLoanerId);
                if (!loaner) return;
                
                // Actualizar estado del Chromebook de préstamo
                loaner.status = 'assigned';
                loaner.assignedTo = editingRepairId || repairIdInput.value;
                
                // Si se ha proporcionado una fecha de devolución, guardarla
                if (loanerReturnDateInput.value) {
                    loaner.returnDate = loanerReturnDateInput.value;
                }
                
                // Actualizar estado visual
                updateLoanerStatusBadge(true);
                
                // Actualizar la avería con el ID del préstamo
                if (editingRepairId) {
                    const repair = repairs.find(r => r.id === editingRepairId);
                    if (repair) {
                        repair.loanerChromebook = selectedLoanerId;
                    }
                }
                
                // Guardar estado y actualizar tablas
                saveState();
                renderLoanerTable();
            };
            
            // --- DESASIGNAR PRÉSTAMO ---
            const unassignLoaner = () => {
                const repairId = editingRepairId || repairIdInput.value;
                const repair = repairs.find(r => r.id === repairId);
                
                if (!repair || !repair.loanerChromebook) return;
                
                const loaner = loanerChromebooks.find(l => l.id === repair.loanerChromebook);
                if (loaner) {
                    // Actualizar estado del Chromebook de préstamo
                    loaner.status = 'available';
                    loaner.assignedTo = '';
                    loaner.returnDate = '';
                    
                    // Actualizar la avería
                    repair.loanerChromebook = '';
                    
                    // Actualizar estado visual
                    updateLoanerStatusBadge(false);
                    
                    // Limpiar selector y fecha
                    loanerSelect.value = '';
                    loanerReturnDateInput.value = '';
                    
                    // Guardar estado y actualizar tablas
                    saveState();
                    renderLoanerTable();
                    populateLoanerSelect(); // Actualizar el selector
                }
            };
            
            // --- MODAL HANDLING ---
            const openModal = (repairId = null) => {
                editingRepairId = repairId;
                modalPhotos = [];
                if (repairForm) repairForm.reset();
                if (notesHistoryDiv) notesHistoryDiv.innerHTML = '';
                
                if (modalTitle) modalTitle.textContent = editingRepairId ? translateText('modalTitleEdit') : translateText('modalTitleAdd');
                
                if (editingRepairId) {
                    const repair = repairs.find(r => r.id === editingRepairId);
                    if (repair) {
                        if (repairIdInput) repairIdInput.value = repair.id;
                        if (repairStudentNameInput) repairStudentNameInput.value = repair.studentName;
                        if (repairClassNameInput) repairClassNameInput.value = repair.className;
                        if (repairSerialNumberInput) repairSerialNumberInput.value = repair.serialNumber || ''; // Cargar número de serie
                        if (repairDescriptionInput) repairDescriptionInput.value = repair.description;
                        if (repairStatusInput) repairStatusInput.value = repair.status;
                        if (repairReportedDateInput) repairReportedDateInput.value = repair.reportedDate;
                        if (repairNotesInput) repairNotesInput.value = ''; // Clear for new note
                        if (notesHistoryDiv && repair.notes) {
                            notesHistoryDiv.innerHTML = repair.notes.split('\n').map(note => `<div>${note}</div>`).join('');
                        }
                        if (hasCostCheckbox) hasCostCheckbox.checked = repair.hasCost;
                        if (costAmountInput) costAmountInput.value = repair.costAmount || '';
                        modalPhotos = Array.isArray(repair.photos) ? [...repair.photos] : [];
                    }
                } else {
                    if (repairIdInput) repairIdInput.value = `CB-${Date.now()}`;
                    if (repairReportedDateInput) repairReportedDateInput.value = new Date().toISOString().split('T')[0];
                }
                
                // Poblar el selector de Chromebooks de préstamo
                populateLoanerSelect();
                // Poblar el selector de clases
                populateClassGroupDropdown();
                
                // Actualizar estado visual del préstamo
                if (editingRepairId) {
                    const repair = repairs.find(r => r.id === editingRepairId);
                    updateLoanerStatusBadge(!!repair.loanerChromebook);
                } else {
                    updateLoanerStatusBadge(false);
                }
                
                renderThumbnails();
                if (hasCostCheckbox) toggleCostSection();
                if (repairModal) repairModal.classList.add('flex');
                if (repairModal) repairModal.classList.remove('hidden');
            };
            const closeModal = () => {
                stopCamera();
                if (repairModal) repairModal.classList.add('hidden');
                if (repairModal) repairModal.classList.remove('flex');
            };
            const openConfigModal = () => {
                if (!configModal) return;
                // Load current config into form
                if (appNameInput) appNameInput.value = config.appName;
                if (appDescriptionInput) appDescriptionInput.value = config.appDescription;
                if (languageSelector) languageSelector.value = config.language;
                if (contactEmailInput) contactEmailInput.value = config.contactEmail;
                if (logoPreview && config.appLogoUrl) {
                    logoPreview.src = config.appLogoUrl;
                    logoPreview.classList.remove('hidden');
                } else if (logoPreview) {
                    logoPreview.classList.add('hidden');
                }
                
                // Cargar configuración de PDFs
                if (pdfHeaderTitleInput) pdfHeaderTitleInput.value = config.pdfConfig.headerTitle;
                if (pdfHeaderSubtitleInput) pdfHeaderSubtitleInput.value = config.pdfConfig.headerSubtitle;
                if (pdfFooterLeftInput) pdfFooterLeftInput.value = config.pdfConfig.footerLeft;
                if (pdfFooterRightInput) pdfFooterRightInput.value = config.pdfConfig.footerRight;
                if (pdfAgreementTextEsInput) pdfAgreementTextEsInput.value = config.pdfConfig.agreementTextEs;
                if (pdfAgreementTextEusInput) pdfAgreementTextEusInput.value = config.pdfConfig.agreementTextEus;
                if (pdfSignatureTextEsInput) pdfSignatureTextEsInput.value = config.pdfConfig.signatureTextEs;
                if (pdfSignatureTextEusInput) pdfSignatureTextEusInput.value = config.pdfConfig.signatureTextEus;
                
                // Cargar los nuevos campos
                if (document.getElementById('pdf-loaner-text-es')) {
                    document.getElementById('pdf-loaner-text-es').value = config.pdfConfig.loanerTextEs || '';
                }
                if (document.getElementById('pdf-loaner-text-eus')) {
                    document.getElementById('pdf-loaner-text-eus').value = config.pdfConfig.loanerTextEus || '';
                }
                
                renderClassGroups();
                renderSchoolYears();
                configModal.classList.add('flex');
                configModal.classList.remove('hidden');
            };
            
            const closeConfigModal = () => {
                if (configModal) configModal.classList.add('hidden');
                if (configModal) configModal.classList.remove('flex');
            };
            const openLoanerModal = (loanerId = null) => {
                editingLoanerId = loanerId;
                if(loanerForm) loanerForm.reset();
                populateLoanerAssignmentDropdown();
                if (loanerModalTitle) loanerModalTitle.textContent = editingLoanerId ? translateText('loanerModalTitleEdit') : translateText('loanerModalTitleAdd');
                if (loanerIdInput) loanerIdInput.disabled = !!editingLoanerId;
                if (editingLoanerId) {
                    const loaner = loanerChromebooks.find(l => l.id === editingLoanerId);
                    if (loaner) {
                        if (loanerIdInput) loanerIdInput.value = loaner.id;
                        if (loanerStatusSelect) loanerStatusSelect.value = loaner.status;
                        if (loanerAssignedToInput) loanerAssignedToInput.value = loaner.assignedTo || '';
                    }
                }
                if (loanerStatusSelect) toggleLoanerAssignmentSection();
                if (loanerModal) loanerModal.classList.add('flex');
                if (loanerModal) loanerModal.classList.remove('hidden');
            };
            
            const closeLoanerModal = () => {
                if (loanerModal) loanerModal.classList.add('hidden');
                if (loanerModal) loanerModal.classList.remove('flex');
            };
            const openReportsModal = () => {
                if (reportsModal) reportsModal.classList.add('flex');
                if (reportsModal) reportsModal.classList.remove('hidden');
            };
            const closeReportsModal = () => {
                if (reportsModal) reportsModal.classList.add('hidden');
                if (reportsModal) reportsModal.classList.remove('flex');
            };
            // --- CRUD & Actions ---
            const addOrUpdateRepair = (e) => {
                e.preventDefault();
                const id = repairIdInput.value;
                const now = new Date();
                const timestamp = `${now.toLocaleDateString()} ${now.toLocaleTimeString()}`;
                let newNote = repairNotesInput.value.trim();
                if (newNote) {
                    newNote = `${timestamp}: ${newNote}`;
                }
                const existingRepair = repairs.find(r => r.id === id);
                const oldNotes = existingRepair ? existingRepair.notes : '';
                const combinedNotes = oldNotes ? `${oldNotes}\n${newNote}` : newNote;
                const newRepair = {
                    id: id,
                    studentName: repairStudentNameInput.value,
                    className: repairClassNameInput.value,
                    serialNumber: repairSerialNumberInput.value, // Guardar número de serie
                    description: repairDescriptionInput.value,
                    status: repairStatusInput.value,
                    reportedDate: repairReportedDateInput.value,
                    repairedDate: repairStatusInput.value === 'repaired' ? new Date().toISOString().split('T')[0] : (existingRepair?.repairedDate || null),
                    notes: newNote ? combinedNotes.trim() : oldNotes,
                    photos: modalPhotos,
                    hasCost: hasCostCheckbox.checked,
                    costAmount: hasCostCheckbox.checked ? parseFloat(costAmountInput.value) || 0 : 0,
                    loanerChromebook: existingRepair?.loanerChromebook || ''
                };
                if (editingRepairId) {
                    repairs = repairs.map(r => r.id === editingRepairId ? newRepair : r);
                } else {
                    repairs.push(newRepair);
                }
                saveState();
                renderTable();
                renderChart();
                renderMonthlyChart();
                renderClassChart();
                renderStudentsChart();
                closeModal();
            };
            const deleteRepair = (id) => {
                if (confirm(translateText('confirmDelete'))) {
                    // Verificar si hay un Chromebook de préstamo asignado
                    const repair = repairs.find(r => r.id === id);
                    if (repair && repair.loanerChromebook) {
                        const loaner = loanerChromebooks.find(l => l.id === repair.loanerChromebook);
                        if (loaner) {
                            // Liberar el Chromebook de préstamo
                            loaner.status = 'available';
                            loaner.assignedTo = '';
                            loaner.returnDate = '';
                        }
                    }
                    
                    repairs = repairs.filter(r => r.id !== id);
                    saveState();
                    renderTable();
                    renderChart();
                    renderMonthlyChart();
                    renderClassChart();
                    renderStudentsChart();
                    renderLoanerTable();
                }
            };
            
            const deleteSelectedRepairs = () => {
                if (selectedRepairIds.size === 0) return;
                if (confirm(translateText('confirmDeleteSelected'))) {
                    // Verificar si hay Chromebooks de préstamo asignados
                    repairs.forEach(repair => {
                        if (selectedRepairIds.has(repair.id) && repair.loanerChromebook) {
                            const loaner = loanerChromebooks.find(l => l.id === repair.loanerChromebook);
                            if (loaner) {
                                // Liberar el Chromebook de préstamo
                                loaner.status = 'available';
                                loaner.assignedTo = '';
                                loaner.returnDate = '';
                            }
                        }
                    });
                    
                    repairs = repairs.filter(r => !selectedRepairIds.has(r.id));
                    selectedRepairIds.clear();
                    saveState();
                    renderTable();
                    renderChart();
                    renderMonthlyChart();
                    renderClassChart();
                    renderStudentsChart();
                    renderLoanerTable();
                    if (selectAllRepairsCheckbox) selectAllRepairsCheckbox.checked = false;
                }
            };
            const addLoaner = (loaner) => {
                loanerChromebooks.push(loaner);
                saveState();
                renderLoanerTable();
            };
            const updateLoaner = (updatedLoaner) => {
                loanerChromebooks = loanerChromebooks.map(l => l.id === updatedLoaner.id ? updatedLoaner : l);
                saveState();
                renderLoanerTable();
                renderTable(); // To update loaner info in repairs table if needed
            };
            const deleteLoaner = (id) => {
                 if (confirm(translateText('confirmDeleteLoaner'))) {
                    // Verificar si el Chromebook está asignado a alguna avería
                    const assignedRepair = repairs.find(r => r.loanerChromebook === id);
                    if (assignedRepair) {
                        // Quitar la asignación de la avería
                        assignedRepair.loanerChromebook = '';
                    }
                    
                    loanerChromebooks = loanerChromebooks.filter(l => l.id !== id);
                    saveState();
                    renderLoanerTable();
                    renderTable();
                }
            };
            // --- CONFIGURATION MANAGEMENT ---
            const loadConfig = () => {
                config = JSON.parse(localStorage.getItem('config')) || {
                    appName: 'Panel de Averías',
                    appDescription: 'Gestión de reparaciones de Chromebooks',
                    appLogoUrl: '',
                    language: 'es',
                    classGroups: ['DBH 1', 'DBH 2', 'DBH 3', 'DBH 4', 'BAT 1', 'BAT 2'],
                    contactEmail: 'contacto@centroeducativo.com',
                    schoolYears: [
                        { name: '2023-2024', startDate: '2023-09-01', endDate: '2024-07-15' },
                        { name: '2024-2025', startDate: '2024-09-01', endDate: '2025-07-15' }
                    ],
                    pdfConfig: {
                        headerTitle: 'Informe de Reparación',
                        headerSubtitle: 'Centro Educativo',
                        footerLeft: 'Centro Educativo',
                        footerRight: 'Página {page}',
                        agreementTextEs: 'Este documento detalla la avería reportada para el Chromebook asignado al alumno/a. La reparación puede incurrir en costes si se determina que el daño fue causado por un mal uso. Para cualquier consulta, por favor contacte con nosotros en la siguiente dirección de correo electrónico: {email}. La firma a continuación implica la aceptación de las condiciones de reparación y la recepción de este informe.',
                        agreementTextEus: 'Dokumentu honek ikasleari esleitutako Chromebook-erako jakinarazitako matxura zehazten du. Konponketak kostuak ekar ditzake kaltea erabilera desegokiagatik izan dela zehazten bada. Edozein zalantza argitzeko, jar zaitez gurekin harremanetan hurrengo helbide elektronikoan: {email}. Beheko sinadurak konponketa baldintzak onartzen dituzula eta txosten hau jaso duzula esan nahi du.',
                        signatureTextEs: 'Firma de los padres / tutor legal:',
                        signatureTextEus: 'Gurasoen / legezko tutorearen sinadura:',
                        // Nuevos campos para el texto del Chromebook de préstamo
                        loanerTextEs: 'El Chromebook de préstamo se le entrega al alumno mientras se soluciona el problema. En caso de no aceptar las condiciones, el alumno tendrá un plazo de un mes a partir de la fecha de la avería para hacerse con otro Chromebook por su cuenta. Transcurrido ese mes, el Chromebook prestado tendrá que devolverlo. El Chromebook prestado debe ser devuelto en buenas condiciones. En caso de ruptura, el alumno se hará cargo del coste de reparación.',
                        loanerTextEus: 'Maileguaren Chromebook-a ikasleari ematen zaio arazoa konbitzen den bitartean. Baldintzak onartzen ez badira, ikasleak hilabete bat izango du matxuraren datatik aurrera bere Chromebook-a lortzeko. Hilabete hori igaro ondoren, maileguan emandako Chromebook-a itzuli beharko da. Maileguan emandako Chromebook-a egoera onean itzuli behar da. Apurtuz gero, ikasleak konponketaren kostua bere gain hartuko du.'
                    }
                };
                if (appLogoHeader && config.appLogoUrl) {
                    appLogoHeader.src = config.appLogoUrl;
                    appLogoHeader.classList.remove('hidden');
                }
                applyTranslations();
            };
            const saveConfig = (e) => {
                e.preventDefault();
                config.appName = appNameInput.value;
                config.appDescription = appDescriptionInput.value;
                config.language = languageSelector.value;
                config.contactEmail = contactEmailInput.value;
                
                const logoFile = appLogoInput.files[0];
                if (logoFile) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        config.appLogoUrl = event.target.result;
                        saveState();
                        loadConfig(); // Reload to apply changes everywhere
                        closeConfigModal();
                    };
                    reader.readAsDataURL(logoFile);
                } else {
                    saveState();
                    loadConfig();
                    closeConfigModal();
                }
            };
            
            const savePdfConfig = (e) => {
                e.preventDefault();
                config.pdfConfig = {
                    headerTitle: pdfHeaderTitleInput.value,
                    headerSubtitle: pdfHeaderSubtitleInput.value,
                    footerLeft: pdfFooterLeftInput.value,
                    footerRight: pdfFooterRightInput.value,
                    agreementTextEs: pdfAgreementTextEsInput.value,
                    agreementTextEus: pdfAgreementTextEusInput.value,
                    signatureTextEs: pdfSignatureTextEsInput.value,
                    signatureTextEus: pdfSignatureTextEusInput.value,
                    // Guardar los nuevos campos
                    loanerTextEs: document.getElementById('pdf-loaner-text-es').value,
                    loanerTextEus: document.getElementById('pdf-loaner-text-eus').value
                };
                saveState();
                closeConfigModal();
            };
            
            const addClassGroup = (e) => {
                e.preventDefault();
                const newGroup = newClassGroupInput.value.trim();
                if (newGroup && !config.classGroups.includes(newGroup)) {
                    config.classGroups.push(newGroup);
                    saveState();
                    renderClassGroups();
                    populateClassGroupDropdown();
                    newClassGroupInput.value = '';
                }
            };
            
            // Función para añadir un curso académico
            const addSchoolYear = (e) => {
                e.preventDefault();
                
                const name = schoolYearNameInput.value.trim();
                const startDate = schoolYearStartDateInput.value;
                const endDate = schoolYearEndDateInput.value;
                
                if (!name || !startDate || !endDate) {
                    alert('Por favor, completa todos los campos');
                    return;
                }
                
                // Verificar que el nombre no exista ya
                if (config.schoolYears && config.schoolYears.some(sy => sy.name === name)) {
                    alert('Ya existe un curso académico con ese nombre');
                    return;
                }
                
                // Verificar que la fecha de fin sea posterior a la de inicio
                if (new Date(endDate) <= new Date(startDate)) {
                    alert('La fecha de fin debe ser posterior a la fecha de inicio');
                    return;
                }
                
                // Añadir el nuevo curso académico
                if (!config.schoolYears) {
                    config.schoolYears = [];
                }
                
                config.schoolYears.push({
                    name: name,
                    startDate: startDate,
                    endDate: endDate
                });
                
                saveState();
                renderSchoolYears();
                populateSchoolYearSelect();
                
                // Limpiar el formulario
                addSchoolYearForm.reset();
            };
            
            // Función para eliminar un curso académico
            const deleteSchoolYear = (index) => {
                if (confirm(translateText('delete-school-year-confirm'))) {
                    config.schoolYears.splice(index, 1);
                    saveState();
                    renderSchoolYears();
                    populateSchoolYearSelect();
                }
            };
            
            // Modificar la función deleteClassGroup para que también actualice las reparaciones que usan esa clase
            const deleteClassGroup = (groupName) => {
                // Eliminar la clase del array de configuración
                config.classGroups = config.classGroups.filter(g => g !== groupName);
                
                // Actualizar las reparaciones que usan esta clase
                repairs.forEach(repair => {
                    if (repair.className === groupName) {
                        // Asignar una clase por defecto o dejarla vacía
                        repair.className = config.classGroups.length > 0 ? config.classGroups[0] : 'Sin clase';
                    }
                });
                
                saveState();
                renderClassGroups();
                populateClassGroupDropdown();
            };
            
            // --- DATA IMPORT/EXPORT ---
            const exportData = () => {
                const dataToExport = {
                    repairs,
                    loanerChromebooks,
                    config
                };
                const dataStr = JSON.stringify(dataToExport, null, 2);
                const blob = new Blob([dataStr], {type: "application/json"});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `chromebook_repairs_backup_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
            };
            
            const exportToCSV = () => {
                // Crear encabezados CSV
                let csvContent = "ID,Alumno,Clase,Número de Serie,Descripción,Estado,Fecha Reporte,Fecha Reparación,Notas,Tiene Coste,Coste,Chromebook Préstamo\n";
                
                // Añadir datos de cada reparación
                repairs.forEach(repair => {
                    const row = [
                        `"${repair.id}"`,
                        `"${repair.studentName}"`,
                        `"${repair.className}"`,
                        `"${repair.serialNumber || ''}"`,
                        `"${repair.description.replace(/"/g, '""')}"`, // Escapar comillas
                        `"${translateText(repairStatusOptions[repair.status]?.text || repair.status)}"`,
                        `"${formatDate(repair.reportedDate)}"`,
                        `"${repair.status === 'repaired' ? formatDate(repair.repairedDate) : ''}"`,
                        `"${repair.notes ? repair.notes.replace(/"/g, '""') : ''}"`, // Escapar comillas
                        `"${repair.hasCost ? 'Sí' : 'No'}"`,
                        `"${repair.hasCost ? repair.costAmount : ''}"`,
                        `"${repair.loanerChromebook || ''}"`
                    ].join(",");
                    csvContent += row + "\n";
                });
                
                // Crear blob y descargar
                const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `chromebook_repairs_${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                URL.revokeObjectURL(url);
            };
            
            const importData = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        if (importedData.repairs && importedData.loanerChromebooks && importedData.config) {
                            repairs = importedData.repairs;
                            loanerChromebooks = importedData.loanerChromebooks;
                            config = importedData.config;
                            saveState();
                            loadConfig(); // Re-apply config and translations
                            // Full re-render
                            renderTable();
                            renderLoanerTable();
                            renderChart();
                            renderMonthlyChart();
                            renderClassChart();
                            renderStudentsChart();
                            populateClassGroupDropdown();
                            populateSchoolYearSelect();
                            closeConfigModal();
                        } else {
                            alert('El archivo JSON no tiene el formato correcto.');
                        }
                    } catch (error) {
                        alert('Error al leer el archivo JSON.');
                        console.error(error);
                    }
                };
                reader.readAsText(file);
            };
            
            const deleteAllData = () => {
                if (confirm(translateText('confirmDeleteAllData'))) {
                    localStorage.removeItem('repairs');
                    localStorage.removeItem('loanerChromebooks');
                    // We keep config by default, could also be removed:
                    // localStorage.removeItem('config'); 
                    repairs = [];
                    loanerChromebooks = [];
                    saveState();
                    // Full re-render
                    renderTable();
                    renderLoanerTable();
                    renderChart();
                    renderMonthlyChart();
                    renderClassChart();
                    renderStudentsChart();
                }
            };
            // --- UI HELPERS ---
            const toggleCostSection = () => {
                if (hasCostCheckbox.checked) {
                    costAmountSection.classList.remove('hidden');
                } else {
                    costAmountSection.classList.add('hidden');
                }
            };
            
            const toggleLoanerAssignmentSection = () => {
                if (loanerStatusSelect.value === 'assigned') {
                    loanerAssignedToSection.classList.remove('hidden');
                } else {
                    loanerAssignedToSection.classList.add('hidden');
                    loanerAssignedToInput.value = '';
                }
            };
            
            const updateSortIcons = () => {
                document.querySelectorAll('.sortable-th').forEach(th => {
                    const icon = th.querySelector('.sort-icon');
                    if (icon) { // Check if icon exists
                        if (th.dataset.sort === currentSort.column) {
                            icon.className = `sort-icon ${currentSort.order}`;
                        } else {
                            icon.className = 'sort-icon';
                        }
                    }
                });
            };
            const updateDeleteSelectedButtonVisibility = () => {
                if (!deleteSelectedRepairsBtn) return;
                if (selectedRepairIds.size > 0) {
                    deleteSelectedRepairsBtn.classList.remove('hidden');
                } else {
                    deleteSelectedRepairsBtn.classList.add('hidden');
                }
            };
            
            // --- CAMERA & PHOTO HANDLING ---
            const renderThumbnails = (selectedIndex = 0) => {
                photoThumbnailsContainer.innerHTML = '';
                if (modalPhotos.length > 0) {
                    mainPhotoPreview.src = modalPhotos[selectedIndex];
                    mainPhotoPreview.classList.remove('hidden');
                    photoPlaceholder.classList.add('hidden');
                    cameraFeed.classList.add('hidden');
                    modalPhotos.forEach((photoSrc, index) => {
                        const wrapper = document.createElement('div');
                        wrapper.className = 'thumbnail-wrapper';
                        const img = document.createElement('img');
                        img.src = photoSrc;
                        img.className = 'thumbnail-img';
                        if (index === selectedIndex) {
                            img.classList.add('selected');
                        }
                        img.addEventListener('click', () => renderThumbnails(index));
                        const deleteBtn = document.createElement('button');
                        deleteBtn.type = 'button';
                        deleteBtn.className = 'thumbnail-delete-btn';
                        deleteBtn.innerHTML = '&times;';
                        deleteBtn.addEventListener('click', () => {
                            modalPhotos.splice(index, 1);
                            renderThumbnails();
                        });
                        wrapper.appendChild(img);
                        wrapper.appendChild(deleteBtn);
                        photoThumbnailsContainer.appendChild(wrapper);
                    });
                } else {
                    mainPhotoPreview.src = '#';
                    mainPhotoPreview.classList.add('hidden');
                    photoPlaceholder.classList.remove('hidden');
                    cameraFeed.classList.add('hidden');
                }
                stopCamera();
            };
            const startCamera = async () => {
                if (cameraStream) {
                    stopCamera();
                    return;
                }
                try {
                    cameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                    if (cameraFeed) {
                        cameraFeed.srcObject = cameraStream;
                        cameraFeed.classList.remove('hidden');
                    }
                    if (mainPhotoPreview) mainPhotoPreview.classList.add('hidden');
                    if (photoPlaceholder) photoPlaceholder.classList.add('hidden');
                    if (takePictureBtn) takePictureBtn.classList.remove('hidden');
                    if (capturePhotoBtn) capturePhotoBtn.textContent = 'Detener Cámara';
                } catch (err) {
                    console.error("Error accessing camera: ", err);
                    alert('No se pudo acceder a la cámara. Asegúrate de dar permiso.');
                }
            };
            const stopCamera = () => {
                if (cameraStream) {
                    cameraStream.getTracks().forEach(track => track.stop());
                    cameraStream = null;
                }
                if (cameraFeed) cameraFeed.classList.add('hidden');
                if (takePictureBtn) takePictureBtn.classList.add('hidden');
                if (capturePhotoBtn) capturePhotoBtn.textContent = translateText('capture-photo-btn');
                
                if (modalPhotos.length === 0) {
                    if(photoPlaceholder) photoPlaceholder.classList.remove('hidden');
                    if(mainPhotoPreview) mainPhotoPreview.classList.add('hidden');
                } else {
                     if(photoPlaceholder) photoPlaceholder.classList.add('hidden');
                     if(mainPhotoPreview) mainPhotoPreview.classList.remove('hidden');
                }
            };
            const takePicture = () => {
                const canvas = document.createElement('canvas');
                canvas.width = cameraFeed.videoWidth;
                canvas.height = cameraFeed.videoHeight;
                const context = canvas.getContext('2d');
                context.drawImage(cameraFeed, 0, 0, canvas.width, canvas.height);
                modalPhotos.push(canvas.toDataURL('image/png'));
                renderThumbnails(modalPhotos.length - 1);
            };
            const handlePhotoUpload = (files) => {
                if (files && files.length > 0) {
                    for (const file of files) {
                        if (file.type.startsWith('image/')) {
                            const reader = new FileReader();
                            reader.onload = (e) => {
                                modalPhotos.push(e.target.result);
                                renderThumbnails(modalPhotos.length - 1);
                            };
                            reader.readAsDataURL(file);
                        }
                    }
                }
            };
            // --- AUTOCOMPLETE ---
            const showSuggestions = (inputElement, suggestionsContainer, items) => {
                const value = inputElement.value.toLowerCase();
                suggestionsContainer.innerHTML = '';
                if (!value) {
                    suggestionsContainer.classList.add('hidden');
                    return;
                }
                const filteredItems = items.filter(item => item.toLowerCase().includes(value));
                if (filteredItems.length > 0) {
                    suggestionsContainer.classList.remove('hidden');
                    filteredItems.forEach(item => {
                        const div = document.createElement('div');
                        div.className = 'autocomplete-suggestion';
                        div.textContent = item;
                        div.addEventListener('click', () => {
                            inputElement.value = item;
                            suggestionsContainer.classList.add('hidden');
                        });
                        suggestionsContainer.appendChild(div);
                    });
                } else {
                    suggestionsContainer.classList.add('hidden');
                }
            };
            // --- PDF GENERATION ---
            const { jsPDF } = window.jspdf;
            const generatePdf = async (repairsToPrint, reportTitle, sumCost = false) => {
                const doc = new jsPDF();
                const pageHeight = doc.internal.pageSize.height;
                const margin = 15;
                let y = 20;
                
                // Configuración de PDF
                const pdfConfig = config.pdfConfig || {};
                const headerTitle = pdfConfig.headerTitle || 'Informe de Reparación';
                const headerSubtitle = pdfConfig.headerSubtitle || 'Centro Educativo';
                const footerLeft = pdfConfig.footerLeft || 'Centro Educativo';
                const footerRight = pdfConfig.footerRight || 'Página {page}';
                const agreementText = config.language === 'eus' 
                    ? (pdfConfig.agreementTextEus || 'Dokumentu honek ikasleari esleitutako Chromebook-erako jakinarazitako matxura zehazten du. Konponketak kostuak ekar ditzake kaltea erabilera desegokiagatik izan dela zehazten bada. Edozein zalantza argitzeko, jar zaitez gurekin harremanetan hurrengo helbide elektronikoan: {email}. Beheko sinadurak konponketa baldintzak onartzen dituzula eta txosten hau jaso duzula esan nahi du.')
                    : (pdfConfig.agreementTextEs || 'Este documento detalla la avería reportada para el Chromebook asignado al alumno/a. La reparación puede incurrir en costes si se determina que el daño fue causado por un mal uso. Para cualquier consulta, por favor contacte con nosotros en la siguiente dirección de correo electrónico: {email}. La firma a continuación implica la aceptación de las condiciones de reparación y la recepción de este informe.');
                const signatureText = config.language === 'eus'
                    ? (pdfConfig.signatureTextEus || 'Gurasoen / legezko tutorearen sinadura:')
                    : (pdfConfig.signatureTextEs || 'Firma de los padres / tutor legal:');
                
                for (const [index, repair] of repairsToPrint.entries()) {
                    if (index > 0) {
                        doc.addPage();
                    }
                    y = 20;
                    
                    // Header
                    if (config.appLogoUrl) {
                        try {
                            await new Promise((resolve) => {
                                const img = new Image();
                                img.src = config.appLogoUrl;
                                img.onload = () => {
                                    doc.addImage(img, 'PNG', margin, y - 5, 15, 15);
                                    resolve();
                                };
                                img.onerror = resolve;
                            });
                        } catch (e) { console.error("Error loading image for PDF header:", e); }
                    }
                    doc.setFontSize(18);
                    doc.setFont('helvetica', 'bold');
                    doc.text(headerTitle, margin + 20, y);
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'normal');
                    doc.text(headerSubtitle, margin + 20, y + 7);
                    y += 25;
                    
                    // Main Info Box
                    doc.setDrawColor(200);
                    doc.setLineWidth(0.2);
                    doc.rect(margin, y, doc.internal.pageSize.width - (2 * margin), 35);
                    
                    const col1X = margin + 5;
                    const col2X = margin + 95;
                    let yInfo = y + 8;
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'bold');
                    doc.text(`${translateText('labelId')}:`, col1X, yInfo);
                    doc.text(`${translateText('labelStatus')}:`, col2X, yInfo);
                    yInfo += 7;
                    doc.text(`${translateText('labelStudentName')}:`, col1X, yInfo);
                    doc.text(`${translateText('labelReportedDate')}:`, col2X, yInfo);
                    yInfo += 7;
                    doc.text(`${translateText('labelClassName')}:`, col1X, yInfo);
                    doc.text(`${translateText('labelRepairedDate')}:`, col2X, yInfo);
                    yInfo += 7;
                    doc.text(`Número de Serie:`, col1X, yInfo);
                    doc.setFont('helvetica', 'normal');
                    yInfo = y + 8;
                    doc.text(repair.id, col1X + 35, yInfo);
                    doc.text(translateText(repairStatusOptions[repair.status]?.text || repair.status), col2X + 35, yInfo);
                    yInfo += 7;
                    doc.text(repair.studentName, col1X + 35, yInfo);
                    doc.text(formatDate(repair.reportedDate), col2X + 35, yInfo);
                    yInfo += 7;
                    doc.text(repair.className, col1X + 35, yInfo);
                    doc.text(formatDate(repair.repairedDate), col2X + 35, yInfo);
                    yInfo += 7;
                    doc.text(repair.serialNumber || '---', col1X + 35, yInfo);
                    y += 40;
                    
                    // Description & Notes
                    const renderTextBox = (labelKey, content) => {
                        doc.setFont('helvetica', 'bold');
                        doc.text(translateText(labelKey), margin, y);
                        y += 6;
                        doc.setDrawColor(220);
                        const splitText = doc.splitTextToSize(content || '---', doc.internal.pageSize.width - (2 * margin) - 4);
                        const boxHeight = splitText.length * 5 + 8;
                        doc.rect(margin, y, doc.internal.pageSize.width - (2 * margin), boxHeight);
                        doc.setFont('helvetica', 'normal');
                        doc.text(splitText, margin + 2, y + 5);
                        y += boxHeight + 5;
                    };
                    renderTextBox('labelDescription', repair.description);
                    renderTextBox('labelNotes', repair.notes);
                    
                    // Photos in two columns
                    if (repair.photos && repair.photos.length > 0) {
                        const photoMargin = 5;
                        const availableWidth = doc.internal.pageSize.width - (margin * 2);
                        const photoWidth = (availableWidth - photoMargin) / 2;
                        let maxRowHeight = 0;
                        for (let i = 0; i < repair.photos.length; i++) {
                            const photoSrc = repair.photos[i];
                            try {
                                const imgProps = doc.getImageProperties(photoSrc);
                                const photoHeight = (imgProps.height * photoWidth) / imgProps.width;
                                
                                if (photoHeight > maxRowHeight) {
                                    maxRowHeight = photoHeight;
                                }
                                // Check for page break before drawing the row
                                if (i % 2 === 0 && y + maxRowHeight > pageHeight - 20) {
                                    doc.addPage();
                                    y = margin;
                                    maxRowHeight = photoHeight; // Reset maxRowHeight for the new page
                                }
                                doc.addImage(photoSrc, 'PNG', margin + (i % 2) * (photoWidth + photoMargin), y, photoWidth, photoHeight);
                                if (i % 2 === 1) { // Right column
                                    y += maxRowHeight + 5;
                                    maxRowHeight = 0; // Reset for the next row
                                }
                            } catch (e) {
                                console.error("Error adding image to PDF:", e);
                            }
                        }
                    }
                    
                    // Cost section
                    if (repair.hasCost) {
                        if (y + 10 > pageHeight - margin) { doc.addPage(); y = margin; }
                        doc.setFont('helvetica', 'bold');
                        doc.text(`${translateText('labelCostAmount')}:`, margin, y);
                        doc.setFont('helvetica', 'normal');
                        doc.text(`${repair.costAmount.toFixed(2)}€`, margin + 30, y);
                        y += 10;
                    }
                    
                    // Loaner Chromebook section - MEJORADO
                    if (repair.loanerChromebook) {
                        if (y + 65 > pageHeight - margin) { doc.addPage(); y = margin; }
                        
                        // Título de la sección
                        doc.setFontSize(12);
                        doc.setFont('helvetica', 'bold');
                        doc.text(translateText('label-loaner-section'), margin, y);
                        y += 8;
                        
                        // Crear un recuadro para la información del préstamo
                        doc.setDrawColor(180);
                        doc.setLineWidth(0.3);
                        doc.rect(margin, y, doc.internal.pageSize.width - (2 * margin), 55);
                        
                        // Buscar información del préstamo
                        const loaner = loanerChromebooks.find(l => l.id === repair.loanerChromebook);
                        const loanerStatus = loaner ? loaner.status : 'unknown';
                        const statusText = loanerStatus ? translateText(loanerStatusOptions[loanerStatus]?.text || loanerStatus) : '';
                        
                        // Mostrar información del préstamo (sin fecha de devolución)
                        doc.setFontSize(10);
                        doc.setFont('helvetica', 'bold');
                        doc.text(`${translateText('label-loaner-id')}:`, margin + 5, y + 8);
                        doc.setFont('helvetica', 'normal');
                        doc.text(repair.loanerChromebook, margin + 40, y + 8);
                        
                        doc.setFont('helvetica', 'bold');
                        doc.text(`${translateText('label-loaner-status')}:`, margin + 90, y + 8);
                        doc.setFont('helvetica', 'normal');
                        doc.text(statusText, margin + 125, y + 8);
                        
                        // Agregar el texto explicativo (usando el texto configurable)
                        y += 15; // Espacio para el texto explicativo
                        doc.setFontSize(8);
                        doc.setFont('helvetica', 'italic');
                        
                        // Usar el texto configurado según el idioma
                        const loanerText = config.language === 'eus' 
                            ? (pdfConfig.loanerTextEus || 'Maileguaren Chromebook-a ikasleari ematen zaio arazoa konbitzen den bitartean...')
                            : (pdfConfig.loanerTextEs || 'El Chromebook de préstamo se le entrega al alumno mientras se soluciona el problema...');
                        
                        const splitExplanation = doc.splitTextToSize(loanerText, doc.internal.pageSize.width - (2 * margin) - 10);
                        doc.text(splitExplanation, margin + 5, y);
                        
                        y += 60; // Ajustamos la posición Y para el siguiente contenido
                    } else {
                        // Si no tiene préstamo asignado, mostrar un mensaje indicándolo
                        if (y + 15 > pageHeight - margin) { doc.addPage(); y = margin; }
                        
                        doc.setFontSize(10);
                        doc.setFont('helvetica', 'italic');
                        doc.text(`${translateText('loaner-status-not-assigned')}`, margin, y);
                        y += 10;
                    }
                    
                    // Parent Agreement Section - CORREGIDO
                    const finalAgreementText = agreementText.replace('{email}', config.contactEmail);
                    
                    // Calcular altura necesaria para el acuerdo y la firma
                    const agreementFontSize = 9;
                    const signatureFontSize = 10;
                    const lineHeight = 5;
                    
                    // Calcular altura del texto del acuerdo
                    doc.setFontSize(agreementFontSize);
                    doc.setFont('helvetica', 'italic');
                    const splitAgreement = doc.splitTextToSize(finalAgreementText, doc.internal.pageSize.width - (2 * margin) - 10);
                    const agreementHeight = splitAgreement.length * lineHeight;
                    
                    // Calcular altura de la sección de firma
                    const signatureHeight = 25; // Espacio para línea de firma y texto
                    
                    // Altura total necesaria para la sección completa
                    const titleHeight = 8; // Altura del título
                    const topMargin = 8; // Margen superior dentro del recuadro
                    const bottomMargin = 8; // Margen inferior dentro del recuadro
                    const totalBoxHeight = titleHeight + topMargin + agreementHeight + 10 + signatureHeight + bottomMargin;
                    
                    // Verificar si necesitamos una nueva página
                    if (y + totalBoxHeight + 10 > pageHeight - margin) {
                        doc.addPage();
                        y = margin;
                    }
                    
                    // Título para la sección de condiciones
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'bold');
                    doc.text('Condiciones de Reparación y Aceptación', margin, y);
                    y += titleHeight;
                    
                    // Crear un recuadro para las condiciones
                    doc.setDrawColor(180);
                    doc.setLineWidth(0.3);
                    doc.rect(margin, y, doc.internal.pageSize.width - (2 * margin), totalBoxHeight);
                    
                    y += topMargin; // Margen superior dentro del recuadro
                    
                    // Dibujar el texto del acuerdo
                    doc.setFontSize(agreementFontSize);
                    doc.setFont('helvetica', 'italic');
                    doc.text(splitAgreement, margin + 5, y);
                    y += agreementHeight + 10; // 10 de separación entre el acuerdo y la firma
                    
                    // Línea para la firma
                    doc.line(margin, y, margin + 80, y);
                    y += 5;
                    doc.setFontSize(signatureFontSize);
                    doc.setFont('helvetica', 'normal');
                    doc.text(signatureText, margin, y);
                    
                    // Footer
                    const pageCount = doc.internal.getNumberOfPages();
                    for (let i = 1; i <= pageCount; i++) {
                        doc.setPage(i);
                        doc.setFontSize(8);
                        doc.setFont('helvetica', 'normal');
                        doc.text(footerLeft, margin, pageHeight - 10);
                        doc.text(footerRight.replace('{page}', i.toString()), doc.internal.pageSize.width - margin - 20, pageHeight - 10);
                    }
                }
                doc.save(`${reportTitle.replace(/\s/g, '_')}.pdf`);
            };
            
            // Generar informe resumen
            const generateSummaryReport = async () => {
                const startDate = summaryStartDate.value ? new Date(summaryStartDate.value) : null;
                const endDate = summaryEndDate.value ? new Date(summaryEndDate.value) : null;
                
                // Filtrar reparaciones por rango de fechas
                let filteredRepairs = [...repairs];
                
                if (startDate) {
                    filteredRepairs = filteredRepairs.filter(r => new Date(r.reportedDate) >= startDate);
                }
                
                if (endDate) {
                    endDate.setHours(23, 59, 59, 999);
                    filteredRepairs = filteredRepairs.filter(r => new Date(r.reportedDate) <= endDate);
                }
                
                if (filteredRepairs.length === 0) {
                    alert('No hay datos para el período seleccionado');
                    return;
                }
                
                const doc = new jsPDF();
                const pageHeight = doc.internal.pageSize.height;
                const margin = 15;
                let y = 20;
                
                // Configuración de PDF
                const pdfConfig = config.pdfConfig || {};
                const headerTitle = pdfConfig.headerTitle || 'Informe de Reparación';
                const headerSubtitle = pdfConfig.headerSubtitle || 'Centro Educativo';
                const footerLeft = pdfConfig.footerLeft || 'Centro Educativo';
                const footerRight = pdfConfig.footerRight || 'Página {page}';
                
                // Header
                if (config.appLogoUrl) {
                    try {
                        await new Promise((resolve) => {
                            const img = new Image();
                            img.src = config.appLogoUrl;
                            img.onload = () => {
                                doc.addImage(img, 'PNG', margin, y - 5, 15, 15);
                                resolve();
                            };
                            img.onerror = resolve;
                        });
                    } catch (e) { console.error("Error loading image for PDF header:", e); }
                }
                
                doc.setFontSize(18);
                doc.setFont('helvetica', 'bold');
                doc.text(translateText('report-summary-title'), margin + 20, y);
                doc.setFontSize(12);
                doc.setFont('helvetica', 'normal');
                doc.text(headerSubtitle, margin + 20, y + 7);
                y += 25;
                
                // Fecha de generación
                doc.setFontSize(10);
                doc.setFont('helvetica', 'italic');
                doc.text(`${translateText('summary-generated-on')}: ${formatDateTime(new Date())}`, margin, y);
                y += 15;
                
                // Resumen General
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.text(translateText('summary-general-title'), margin, y);
                y += 10;
                
                const totalRepairs = filteredRepairs.length;
                const totalCost = filteredRepairs.reduce((sum, repair) => sum + (repair.costAmount || 0), 0);
                const averageCost = totalRepairs > 0 ? totalCost / totalRepairs : 0;
                
                // Tabla de resumen general
                doc.autoTable({
                    startY: y,
                    head: [[translateText('summary-total-repairs'), translateText('summary-total-cost'), translateText('summary-average-cost')]],
                    body: [[totalRepairs.toString(), `${totalCost.toFixed(2)}€`, `${averageCost.toFixed(2)}€`]],
                    theme: 'grid',
                    headStyles: { fillColor: [230, 230, 230], textColor: 20 },
                    margin: { left: margin, right: margin }
                });
                
                y = doc.autoTable.previous.finalY + 15;
                
                // Resumen por Clase
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.text(translateText('summary-by-class-title'), margin, y);
                y += 10;
                
                // Agrupar por clase
                const classSummary = {};
                filteredRepairs.forEach(repair => {
                    if (!classSummary[repair.className]) {
                        classSummary[repair.className] = {
                            count: 0,
                            totalCost: 0,
                            pending: 0,
                            inProgress: 0,
                            repaired: 0,
                            unrepairable: 0
                        };
                    }
                    classSummary[repair.className].count++;
                    classSummary[repair.className].totalCost += repair.costAmount || 0;
                    classSummary[repair.className][repair.status]++;
                });
                
                // Preparar datos para la tabla
                const classTableData = [];
                for (const className in classSummary) {
                    const data = classSummary[className];
                    classTableData.push([
                        className,
                        data.count.toString(),
                        `${data.totalCost.toFixed(2)}€`,
                        data.pending.toString(),
                        data.inProgress.toString(),
                        data.repaired.toString(),
                        data.unrepairable.toString()
                    ]);
                }
                
                // Ordenar por número de averías (descendente)
                classTableData.sort((a, b) => parseInt(b[1]) - parseInt(a[1]));
                
                // Tabla de resumen por clase
                doc.autoTable({
                    startY: y,
                    head: [
                        [
                            translateText('labelClassName'),
                            translateText('summary-repairs-count'),
                            translateText('summary-total-cost'),
                            translateText('status_pending'),
                            translateText('status_in_progress'),
                            translateText('status_repaired'),
                            translateText('status_unrepairable')
                        ]
                    ],
                    body: classTableData,
                    theme: 'grid',
                    headStyles: { fillColor: [230, 230, 230], textColor: 20 },
                    margin: { left: margin, right: margin }
                });
                
                y = doc.autoTable.previous.finalY + 15;
                
                // Top 10 Alumnos con Más Averías
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.text(translateText('summary-top-students-title'), margin, y);
                y += 10;
                
                // Agrupar por alumno
                const studentSummary = {};
                filteredRepairs.forEach(repair => {
                    if (!studentSummary[repair.studentName]) {
                        studentSummary[repair.studentName] = {
                            count: 0,
                            totalCost: 0,
                            className: repair.className
                        };
                    }
                    studentSummary[repair.studentName].count++;
                    studentSummary[repair.studentName].totalCost += repair.costAmount || 0;
                });
                
                // Preparar datos para la tabla
                const studentTableData = [];
                for (const studentName in studentSummary) {
                    const data = studentSummary[studentName];
                    studentTableData.push([
                        studentName,
                        data.className,
                        data.count.toString(),
                        `${data.totalCost.toFixed(2)}€`
                    ]);
                }
                
                // Ordenar por número de averías (descendente)
                studentTableData.sort((a, b) => parseInt(b[2]) - parseInt(a[2]));
                
                // Limitar a los 10 primeros
                const topStudents = studentTableData.slice(0, 10);
                
                // Añadir posición
                const topStudentsWithPosition = topStudents.map((student, index) => {
                    return [`${index + 1}`, ...student];
                });
                
                // Tabla de top alumnos
                doc.autoTable({
                    startY: y,
                    head: [
                        [
                            translateText('summary-position'),
                            translateText('summary-student-name'),
                            translateText('labelClassName'),
                            translateText('summary-repairs-count'),
                            translateText('summary-total-cost')
                        ]
                    ],
                    body: topStudentsWithPosition,
                    theme: 'grid',
                    headStyles: { fillColor: [230, 230, 230], textColor: 20 },
                    margin: { left: margin, right: margin }
                });
                
                // Footer
                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.setFont('helvetica', 'normal');
                    doc.text(footerLeft, margin, pageHeight - 10);
                    doc.text(footerRight.replace('{page}', i.toString()), doc.internal.pageSize.width - margin - 20, pageHeight - 10);
                }
                
                doc.save(`Informe_Resumen_${new Date().toISOString().split('T')[0]}.pdf`);
            };
            
            // Generar informe total por clase
            const generateTotalClassReport = async () => {
                const startDate = totalClassStartDate.value ? new Date(totalClassStartDate.value) : null;
                const endDate = totalClassEndDate.value ? new Date(totalClassEndDate.value) : null;
                
                // Filtrar reparaciones por rango de fechas
                let filteredRepairs = [...repairs];
                
                if (startDate) {
                    filteredRepairs = filteredRepairs.filter(r => new Date(r.reportedDate) >= startDate);
                }
                
                if (endDate) {
                    endDate.setHours(23, 59, 59, 999);
                    filteredRepairs = filteredRepairs.filter(r => new Date(r.reportedDate) <= endDate);
                }
                
                if (filteredRepairs.length === 0) {
                    alert('No hay datos para el período seleccionado');
                    return;
                }
                
                const doc = new jsPDF();
                const pageHeight = doc.internal.pageSize.height;
                const margin = 15;
                let y = 20;
                
                // Configuración de PDF
                const pdfConfig = config.pdfConfig || {};
                const headerTitle = pdfConfig.headerTitle || 'Informe de Reparación';
                const headerSubtitle = pdfConfig.headerSubtitle || 'Centro Educativo';
                const footerLeft = pdfConfig.footerLeft || 'Centro Educativo';
                const footerRight = pdfConfig.footerRight || 'Página {page}';
                
                // Header
                if (config.appLogoUrl) {
                    try {
                        await new Promise((resolve) => {
                            const img = new Image();
                            img.src = config.appLogoUrl;
                            img.onload = () => {
                                doc.addImage(img, 'PNG', margin, y - 5, 15, 15);
                                resolve();
                            };
                            img.onerror = resolve;
                        });
                    } catch (e) { console.error("Error loading image for PDF header:", e); }
                }
                
                doc.setFontSize(18);
                doc.setFont('helvetica', 'bold');
                doc.text(translateText('total-class-report-title'), margin + 20, y);
                doc.setFontSize(12);
                doc.setFont('helvetica', 'normal');
                doc.text(headerSubtitle, margin + 20, y + 7);
                y += 25;
                
                // Período
                doc.setFontSize(10);
                doc.setFont('helvetica', 'italic');
                let periodText = '';
                if (startDate && endDate) {
                    periodText = `${translateText('total-class-period')}: ${formatDate(startDate)} - ${formatDate(endDate)}`;
                } else if (startDate) {
                    periodText = `${translateText('total-class-period')}: Desde ${formatDate(startDate)}`;
                } else if (endDate) {
                    periodText = `${translateText('total-class-period')}: Hasta ${formatDate(endDate)}`;
                } else {
                    periodText = `${translateText('total-class-period')}: Todos los registros`;
                }
                doc.text(periodText, margin, y);
                y += 15;
                
                // Fecha de generación
                doc.text(`${translateText('summary-generated-on')}: ${formatDateTime(new Date())}`, margin, y);
                y += 15;
                
                // Agrupar por clase
                const classSummary = {};
                filteredRepairs.forEach(repair => {
                    if (!classSummary[repair.className]) {
                        classSummary[repair.className] = {
                            count: 0,
                            totalCost: 0,
                            pending: 0,
                            inProgress: 0,
                            repaired: 0,
                            unrepairable: 0
                        };
                    }
                    classSummary[repair.className].count++;
                    classSummary[repair.className].totalCost += repair.costAmount || 0;
                    classSummary[repair.className][repair.status]++;
                });
                
                // Preparar datos para la tabla
                const classTableData = [];
                for (const className in classSummary) {
                    const data = classSummary[className];
                    classTableData.push([
                        className,
                        data.count.toString(),
                        `${data.totalCost.toFixed(2)}€`,
                        data.pending.toString(),
                        data.inProgress.toString(),
                        data.repaired.toString(),
                        data.unrepairable.toString()
                    ]);
                }
                
                // Ordenar por número de averías (descendente)
                classTableData.sort((a, b) => parseInt(b[1]) - parseInt(a[1]));
                
                // Tabla de resumen por clase
                doc.autoTable({
                    startY: y,
                    head: [
                        [
                            translateText('total-class-name'),
                            translateText('total-repairs-count'),
                            translateText('summary-total-cost'),
                            translateText('status_pending'),
                            translateText('status_in_progress'),
                            translateText('status_repaired'),
                            translateText('status_unrepairable')
                        ]
                    ],
                    body: classTableData,
                    theme: 'grid',
                    headStyles: { fillColor: [230, 230, 230], textColor: 20 },
                    margin: { left: margin, right: margin }
                });
                
                // Footer
                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.setFont('helvetica', 'normal');
                    doc.text(footerLeft, margin, pageHeight - 10);
                    doc.text(footerRight.replace('{page}', i.toString()), doc.internal.pageSize.width - margin - 20, pageHeight - 10);
                }
                
                doc.save(`Informe_Total_Clases_${new Date().toISOString().split('T')[0]}.pdf`);
            };
            
            // Generar informe total por alumno
            const generateTotalStudentReport = async () => {
                const startDate = totalStudentStartDate.value ? new Date(totalStudentStartDate.value) : null;
                const endDate = totalStudentEndDate.value ? new Date(totalStudentEndDate.value) : null;
                
                // Filtrar reparaciones por rango de fechas
                let filteredRepairs = [...repairs];
                
                if (startDate) {
                    filteredRepairs = filteredRepairs.filter(r => new Date(r.reportedDate) >= startDate);
                }
                
                if (endDate) {
                    endDate.setHours(23, 59, 59, 999);
                    filteredRepairs = filteredRepairs.filter(r => new Date(r.reportedDate) <= endDate);
                }
                
                if (filteredRepairs.length === 0) {
                    alert('No hay datos para el período seleccionado');
                    return;
                }
                
                const doc = new jsPDF();
                const pageHeight = doc.internal.pageSize.height;
                const margin = 15;
                let y = 20;
                
                // Configuración de PDF
                const pdfConfig = config.pdfConfig || {};
                const headerTitle = pdfConfig.headerTitle || 'Informe de Reparación';
                const headerSubtitle = pdfConfig.headerSubtitle || 'Centro Educativo';
                const footerLeft = pdfConfig.footerLeft || 'Centro Educativo';
                const footerRight = pdfConfig.footerRight || 'Página {page}';
                
                // Header
                if (config.appLogoUrl) {
                    try {
                        await new Promise((resolve) => {
                            const img = new Image();
                            img.src = config.appLogoUrl;
                            img.onload = () => {
                                doc.addImage(img, 'PNG', margin, y - 5, 15, 15);
                                resolve();
                            };
                            img.onerror = resolve;
                        });
                    } catch (e) { console.error("Error loading image for PDF header:", e); }
                }
                
                doc.setFontSize(18);
                doc.setFont('helvetica', 'bold');
                doc.text(translateText('total-student-report-title'), margin + 20, y);
                doc.setFontSize(12);
                doc.setFont('helvetica', 'normal');
                doc.text(headerSubtitle, margin + 20, y + 7);
                y += 25;
                
                // Período
                doc.setFontSize(10);
                doc.setFont('helvetica', 'italic');
                let periodText = '';
                if (startDate && endDate) {
                    periodText = `${translateText('total-student-period')}: ${formatDate(startDate)} - ${formatDate(endDate)}`;
                } else if (startDate) {
                    periodText = `${translateText('total-student-period')}: Desde ${formatDate(startDate)}`;
                } else if (endDate) {
                    periodText = `${translateText('total-student-period')}: Hasta ${formatDate(endDate)}`;
                } else {
                    periodText = `${translateText('total-student-period')}: Todos los registros`;
                }
                doc.text(periodText, margin, y);
                y += 15;
                
                // Fecha de generación
                doc.text(`${translateText('summary-generated-on')}: ${formatDateTime(new Date())}`, margin, y);
                y += 15;
                
                // Agrupar por alumno
                const studentSummary = {};
                filteredRepairs.forEach(repair => {
                    if (!studentSummary[repair.studentName]) {
                        studentSummary[repair.studentName] = {
                            count: 0,
                            totalCost: 0,
                            className: repair.className,
                            pending: 0,
                            inProgress: 0,
                            repaired: 0,
                            unrepairable: 0
                        };
                    }
                    studentSummary[repair.studentName].count++;
                    studentSummary[repair.studentName].totalCost += repair.costAmount || 0;
                    studentSummary[repair.studentName].className = repair.className;
                    studentSummary[repair.studentName][repair.status]++;
                });
                
                // Preparar datos para la tabla
                const studentTableData = [];
                for (const studentName in studentSummary) {
                    const data = studentSummary[studentName];
                    studentTableData.push([
                        studentName,
                        data.className,
                        data.count.toString(),
                        `${data.totalCost.toFixed(2)}€`,
                        data.pending.toString(),
                        data.inProgress.toString(),
                        data.repaired.toString(),
                        data.unrepairable.toString()
                    ]);
                }
                
                // Ordenar por número de averías (descendente)
                studentTableData.sort((a, b) => parseInt(b[2]) - parseInt(a[2]));
                
                // Tabla de resumen por alumno
                doc.autoTable({
                    startY: y,
                    head: [
                        [
                            translateText('total-student-name'),
                            translateText('labelClassName'),
                            translateText('total-repairs-count'),
                            translateText('summary-total-cost'),
                            translateText('status_pending'),
                            translateText('status_in_progress'),
                            translateText('status_repaired'),
                            translateText('status_unrepairable')
                        ]
                    ],
                    body: studentTableData,
                    theme: 'grid',
                    headStyles: { fillColor: [230, 230, 230], textColor: 20 },
                    margin: { left: margin, right: margin }
                });
                
                // Footer
                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.setFont('helvetica', 'normal');
                    doc.text(footerLeft, margin, pageHeight - 10);
                    doc.text(footerRight.replace('{page}', i.toString()), doc.internal.pageSize.width - margin - 20, pageHeight - 10);
                }
                
                doc.save(`Informe_Total_Alumnos_${new Date().toISOString().split('T')[0]}.pdf`);
            };
            
            const generateStatusReport = () => {
                const selectedStatuses = Array.from(reportStatusFilter.selectedOptions).map(opt => opt.value);
                if (selectedStatuses.length === 0) {
                    alert('Por favor, selecciona al menos un estado.');
                    return;
                }
                const repairsToPrint = repairs.filter(r => selectedStatuses.includes(r.status));
                const reportTitle = translateText('report-by-status-title');
                generatePdf(repairsToPrint, reportTitle, sumCostCheckbox.checked);
            };
            const generateStudentReport = () => {
                const studentName = reportStudentNameInput.value.trim();
                if (!studentName) {
                    alert('Por favor, introduce el nombre de un alumno.');
                    return;
                }
                const startDate = reportStudentStartDate.value ? new Date(reportStudentStartDate.value) : null;
                const endDate = reportStudentEndDate.value ? new Date(reportStudentEndDate.value) : null;
                let repairsToPrint = repairs.filter(r => r.studentName.toLowerCase() === studentName.toLowerCase());
                if (startDate) {
                    repairsToPrint = repairsToPrint.filter(r => new Date(r.reportedDate) >= startDate);
                }
                if (endDate) {
                    // Adjust end date to include the whole day
                    endDate.setHours(23, 59, 59, 999);
                    repairsToPrint = repairsToPrint.filter(r => new Date(r.reportedDate) <= endDate);
                }
                
                const reportTitle = `${translateText('report-by-student-title')}: ${studentName}`;
                generatePdf(repairsToPrint, reportTitle, true);
            };
            const generateClassReport = async () => {
                const className = reportClassFilter.value;
                if (!className) {
                    alert('Por favor, selecciona una clase.');
                    return;
                }
                const startDate = reportClassStartDate.value ? new Date(reportClassStartDate.value) : null;
                const endDate = reportClassEndDate.value ? new Date(reportClassEndDate.value) : null;
                let classRepairs = repairs.filter(r => r.className === className);
                
                if (startDate) {
                    classRepairs = classRepairs.filter(r => new Date(r.reportedDate) >= startDate);
                }
                if (endDate) {
                    endDate.setHours(23, 59, 59, 999);
                    classRepairs = classRepairs.filter(r => new Date(r.reportedDate) <= endDate);
                }
                const studentData = classRepairs.reduce((acc, repair) => {
                    if (!acc[repair.studentName]) {
                        acc[repair.studentName] = { count: 0, totalCost: 0, repairs: [] };
                    }
                    acc[repair.studentName].count++;
                    acc[repair.studentName].totalCost += repair.costAmount || 0;
                    acc[repair.studentName].repairs.push(repair);
                    return acc;
                }, {});
                const totalClassCost = classRepairs.reduce((sum, r) => sum + (r.costAmount || 0), 0);
                const doc = new jsPDF();
                const pageHeight = doc.internal.pageSize.height;
                const margin = 15;
                let y = 20;
                
                // Configuración de PDF
                const pdfConfig = config.pdfConfig || {};
                const headerTitle = pdfConfig.headerTitle || 'Informe de Reparación';
                const headerSubtitle = pdfConfig.headerSubtitle || 'Centro Educativo';
                const footerLeft = pdfConfig.footerLeft || 'Centro Educativo';
                const footerRight = pdfConfig.footerRight || 'Página {page}';
                
                // Header
                if (config.appLogoUrl) {
                    try {
                        await new Promise((resolve) => {
                            const img = new Image();
                            img.src = config.appLogoUrl;
                            img.onload = () => { doc.addImage(img, 'PNG', margin, y - 5, 15, 15); resolve(); };
                            img.onerror = resolve;
                        });
                    } catch (e) { console.error("Error loading image for PDF header:", e); }
                }
                doc.setFontSize(18);
                doc.setFont('helvetica', 'bold');
                doc.text(headerTitle, margin + 20, y);
                doc.setFontSize(12);
                doc.setFont('helvetica', 'normal');
                doc.text(`${translateText('report-by-class-title')}: ${className}`, margin + 20, y + 7);
                y += 25;
                
                // Summary Box
                doc.setDrawColor(200);
                doc.setLineWidth(0.2);
                doc.rect(margin, y, doc.internal.pageSize.width - (2 * margin), 15);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.text(`Total Averías en la Clase: ${classRepairs.length}`, margin + 5, y + 9);
                doc.text(`Coste Total de la Clase: ${totalClassCost.toFixed(2)}€`, margin + 95, y + 9);
                y += 25;
                
                // Student Details
                for (const studentName in studentData) {
                    const data = studentData[studentName];
                    
                    if (y + 30 > pageHeight - margin) { doc.addPage(); y = margin; }
                    doc.setLineWidth(0.5);
                    doc.line(margin, y, doc.internal.pageSize.width - margin, y);
                    y += 8;
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'bold');
                    doc.text(`Alumno/a: ${studentName}`, margin, y);
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'normal');
                    doc.text(`Total Averías: ${data.count}`, margin + 95, y);
                    doc.text(`Coste Total: ${data.totalCost.toFixed(2)}€`, margin + 135, y);
                    y += 8;
                    // Table for student's repairs
                    const head = [['ID', 'Fecha', 'Descripción', 'Coste', 'Préstamo']];
                    const body = data.repairs.map(r => [
                        r.id,
                        formatDate(r.reportedDate),
                        r.description,
                        `${r.costAmount.toFixed(2)}€`,
                        r.loanerChromebook || '---'
                    ]);
                    
                    doc.autoTable({
                        startY: y,
                        head: head,
                        body: body,
                        theme: 'grid',
                        headStyles: { fillColor: [230, 230, 230], textColor: 20 },
                        margin: { left: margin, right: margin }
                    });
                    y = doc.autoTable.previous.finalY + 10;
                }
                
                // Footer
                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.setFont('helvetica', 'normal');
                    doc.text(footerLeft, margin, pageHeight - 10);
                    doc.text(footerRight.replace('{page}', i.toString()), doc.internal.pageSize.width - margin - 20, pageHeight - 10);
                }
                
                doc.save(`Informe_Clase_${className.replace(/\s/g, '_')}.pdf`);
            };
            
            // Función auxiliar para mejorar el arrastrar y soltar
            function getDragAfterElement(container, y) {
                const draggableElements = [...container.querySelectorAll('.class-group-row:not(.dragging)')];
                
                return draggableElements.reduce((closest, child) => {
                    const box = child.getBoundingClientRect();
                    const offset = y - box.top - box.height / 2;
                    
                    if (offset < 0 && offset > closest.offset) {
                        return { offset: offset, element: child };
                    } else {
                        return closest;
                    }
                }, { offset: Number.NEGATIVE_INFINITY }).element;
            }
            
            // --- EVENT LISTENERS ---
            // Main buttons
            if (addRepairBtn) addRepairBtn.addEventListener('click', () => openModal());
            if (configBtn) configBtn.addEventListener('click', openConfigModal);
            if (addLoanerBtn) addLoanerBtn.addEventListener('click', () => openLoanerModal());
            if (reportsBtn) reportsBtn.addEventListener('click', openReportsModal);
            
            // Language selector in header
            if (headerLanguageBtn) {
                headerLanguageBtn.addEventListener('click', () => {
                    headerLanguageDropdown.classList.toggle('show');
                });
            }
            
            // Language options
            document.querySelectorAll('.language-option').forEach(option => {
                option.addEventListener('click', () => {
                    const selectedLang = option.dataset.lang;
                    config.language = selectedLang;
                    saveState();
                    applyTranslations();
                    headerLanguageDropdown.classList.remove('show');
                });
            });
            
            // Close language dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!headerLanguageBtn.contains(e.target) && !headerLanguageDropdown.contains(e.target)) {
                    headerLanguageDropdown.classList.remove('show');
                }
            });
            
            // Modal close buttons
            if (closeModalBtn) closeModalBtn.addEventListener('click', closeModal);
            if (closeConfigBtn) closeConfigBtn.addEventListener('click', closeConfigModal);
            if (closeLoanerModalBtn) closeLoanerModalBtn.addEventListener('click', closeLoanerModal);
            if (closeReportsBtn) closeReportsBtn.addEventListener('click', closeReportsModal);
            
            // Forms
            if (repairForm) repairForm.addEventListener('submit', addOrUpdateRepair);
            if (configForm) configForm.addEventListener('submit', saveConfig);
            if (pdfConfigForm) pdfConfigForm.addEventListener('submit', savePdfConfig);
            if (loanerForm) {
                loanerForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const newLoaner = {
                        id: editingLoanerId || loanerIdInput.value,
                        status: loanerStatusSelect.value,
                        assignedTo: loanerStatusSelect.value === 'assigned' ? loanerAssignedToInput.value : '',
                        returnDate: ''
                    };
                    // Handle assignment logic
                    const oldLoaner = loanerChromebooks.find(l => l.id === newLoaner.id);
                    if (oldLoaner && oldLoaner.status === 'assigned' && newLoaner.status !== 'assigned') {
                        const assignedRepair = repairs.find(r => r.loanerChromebook === oldLoaner.id);
                        if (assignedRepair) assignedRepair.loanerChromebook = '';
                    }
                    if (newLoaner.status === 'assigned' && newLoaner.assignedTo) {
                        const targetRepair = repairs.find(r => r.id === newLoaner.assignedTo);
                        if(targetRepair) targetRepair.loanerChromebook = newLoaner.id;
                    }
                    if (editingLoanerId) {
                        updateLoaner(newLoaner);
                    } else {
                        addLoaner(newLoaner);
                    }
                    closeLoanerModal();
                });
            }
            if (addClassGroupForm) addClassGroupForm.addEventListener('submit', addClassGroup);
            
            // Event listener para el formulario de añadir curso académico
            if (addSchoolYearForm) {
                addSchoolYearForm.addEventListener('submit', addSchoolYear);
            }
            
            // Event listener para eliminar cursos académicos
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('delete-school-year-btn')) {
                    const index = parseInt(e.target.dataset.index);
                    deleteSchoolYear(index);
                }
            });
            
            // Table interactions
            if (repairsTableBody) {
                repairsTableBody.addEventListener('click', (e) => {
                    const target = e.target;
                    const id = target.closest('button')?.dataset.id;
                    if (id) {
                        if (target.closest('.edit-btn')) openModal(id);
                        if (target.closest('.delete-btn')) deleteRepair(id);
                        if (target.closest('.pdf-btn')) generatePdf([repairs.find(r => r.id === id)], `Informe_Averia_${id}`);
                    }
                    if (target.classList.contains('repair-checkbox')) {
                        const repairId = target.dataset.id;
                        if (target.checked) {
                            selectedRepairIds.add(repairId);
                        } else {
                            selectedRepairIds.delete(repairId);
                        }
                        updateDeleteSelectedButtonVisibility();
                    }
                });
            }
            if (loanerTableBody) {
                 loanerTableBody.addEventListener('click', (e) => {
                    const id = e.target.closest('button')?.dataset.id;
                    if (!id) return;
                    if (e.target.closest('.edit-loaner-btn')) openLoanerModal(id);
                    if (e.target.closest('.delete-loaner-btn')) deleteLoaner(id);
                });
            }
            // Other UI interactions
            if (hasCostCheckbox) hasCostCheckbox.addEventListener('change', toggleCostSection);
            if (loanerStatusSelect) loanerStatusSelect.addEventListener('change', toggleLoanerAssignmentSection);
            if (uploadPhotoBtn) uploadPhotoBtn.addEventListener('click', () => photoUploadInput.click());
            if (photoUploadInput) photoUploadInput.addEventListener('change', (e) => handlePhotoUpload(e.target.files));
            if (capturePhotoBtn) capturePhotoBtn.addEventListener('click', startCamera);
            if (takePictureBtn) takePictureBtn.addEventListener('click', takePicture);
            
            // Event listeners para la sección de préstamo
            if (assignLoanerBtn) assignLoanerBtn.addEventListener('click', assignLoaner);
            if (unassignLoanerBtn) unassignLoanerBtn.addEventListener('click', unassignLoaner);
            
            // Drag and drop for photo
            if (mainPhotoPreviewContainer) {
                mainPhotoPreviewContainer.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    mainPhotoPreviewContainer.classList.add('drag-over');
                });
                mainPhotoPreviewContainer.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    mainPhotoPreviewContainer.classList.remove('drag-over');
                });
                mainPhotoPreviewContainer.addEventListener('drop', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    mainPhotoPreviewContainer.classList.remove('drag-over');
                    handlePhotoUpload(e.dataTransfer.files);
                });
            }
            // Sorting
            document.querySelectorAll('.sortable-th').forEach(th => {
                th.addEventListener('click', () => {
                    const column = th.dataset.sort;
                    if (currentSort.column === column) {
                        currentSort.order = currentSort.order === 'asc' ? 'desc' : 'asc';
                    } else {
                        currentSort.column = column;
                        currentSort.order = 'asc';
                    }
                    updateSortIcons();
                    renderTable();
                });
            });
            // Autocomplete Listeners
            const allStudentNames = () => [...new Set(repairs.map(r => r.studentName))];
            if (repairStudentNameInput) {
                repairStudentNameInput.addEventListener('input', () => showSuggestions(repairStudentNameInput, studentNameSuggestions, allStudentNames()));
            }
            if (reportStudentNameInput) {
                reportStudentNameInput.addEventListener('input', () => showSuggestions(reportStudentNameInput, reportStudentSuggestions, allStudentNames()));
            }
            // Hide suggestions when clicking outside
            document.addEventListener('click', (e) => {
                if (!studentNameSuggestions.contains(e.target) && e.target !== repairStudentNameInput) {
                    studentNameSuggestions.classList.add('hidden');
                }
                 if (!reportStudentSuggestions.contains(e.target) && e.target !== reportStudentNameInput) {
                    reportStudentSuggestions.classList.add('hidden');
                }
            });
            // Config data management buttons
            if (exportBtn) exportBtn.addEventListener('click', exportData);
            if (exportCsvBtn) exportCsvBtn.addEventListener('click', exportToCSV);
            if (importFileInput) importFileInput.addEventListener('change', importData);
            if (deleteAllDataBtn) deleteAllDataBtn.addEventListener('click', deleteAllData);
            // Config class management
            if (classGroupsList) {
                classGroupsList.addEventListener('click', (e) => {
                    if (e.target.closest('.save-class-group-btn')) {
                        const groupName = e.target.closest('.save-class-group-btn').dataset.group;
                        const row = e.target.closest('.class-group-row');
                        const input = row.querySelector('.class-name-input');
                        const newName = input.value.trim();
                        
                        if (newName && newName !== groupName) {
                            // Actualizar en config.classGroups
                            const index = config.classGroups.indexOf(groupName);
                            if (index !== -1) {
                                config.classGroups[index] = newName;
                            }
                            
                            // Actualizar en todas las reparaciones que tengan esa clase
                            repairs.forEach(repair => {
                                if (repair.className === groupName) {
                                    repair.className = newName;
                                }
                            });
                            
                            saveState();
                            renderClassGroups();
                            populateClassGroupDropdown();
                        }
                    }
                    
                    if (e.target.closest('.delete-class-group-btn')) {
                        const groupName = e.target.closest('.delete-class-group-btn').dataset.group;
                        deleteClassGroup(groupName);
                    }
                });
                
                // Mejorar el manejo de arrastrar y soltar
                let draggedItem = null;
                
                classGroupsList.addEventListener('dragstart', (e) => {
                    if (e.target.classList.contains('class-group-row')) {
                        draggedItem = e.target;
                        e.target.classList.add('dragging');
                    }
                });
                
                classGroupsList.addEventListener('dragend', (e) => {
                    if (e.target.classList.contains('class-group-row')) {
                        e.target.classList.remove('dragging');
                    }
                });
                
                classGroupsList.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    const afterElement = getDragAfterElement(classGroupsList, e.clientY);
                    const currentDragged = document.querySelector('.dragging');
                    
                    if (afterElement == null) {
                        classGroupsList.appendChild(currentDragged);
                    } else {
                        classGroupsList.insertBefore(currentDragged, afterElement);
                    }
                });
                
                classGroupsList.addEventListener('drop', (e) => {
                    e.preventDefault();
                    if (draggedItem) {
                        // Actualizar el orden en el array
                        const newOrder = Array.from(classGroupsList.querySelectorAll('.class-group-row')).map(row => {
                            return row.querySelector('.class-name-input').value;
                        });
                        
                        config.classGroups = newOrder;
                        saveState();
                        renderClassGroups();
                        populateClassGroupDropdown();
                    }
                });
            }
            // Report generation buttons
            if (generateStatusReportBtn) generateStatusReportBtn.addEventListener('click', generateStatusReport);
            if (generateStudentReportBtn) generateStudentReportBtn.addEventListener('click', generateStudentReport);
            if (generateClassReportBtn) generateClassReportBtn.addEventListener('click', generateClassReport);
            if (generateSummaryReportBtn) generateSummaryReportBtn.addEventListener('click', generateSummaryReport);
            if (generateTotalClassReportBtn) generateTotalClassReportBtn.addEventListener('click', generateTotalClassReport);
            if (generateTotalStudentReportBtn) generateTotalStudentReportBtn.addEventListener('click', generateTotalStudentReport);
            // Config Tabs
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', () => {
                    const tabId = button.dataset.tab;
                    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                    button.classList.add('active');
                    document.getElementById(tabId).classList.add('active');
                    
                    // Si es la pestaña de gestión de cursos académicos, renderizamos la lista
                    if (tabId === 'school-year-management') {
                        renderSchoolYears();
                    }
                });
            });
            // Select all checkbox
            if (selectAllRepairsCheckbox) {
                selectAllRepairsCheckbox.addEventListener('change', (e) => {
                    document.querySelectorAll('.repair-checkbox').forEach(checkbox => {
                        checkbox.checked = e.target.checked;
                        const id = checkbox.dataset.id;
                        if (e.target.checked) {
                            selectedRepairIds.add(id);
                        } else {
                            selectedRepairIds.delete(id);
                        }
                    });
                    updateDeleteSelectedButtonVisibility();
                });
            }
            // Delete selected repairs button
            if (deleteSelectedRepairsBtn) deleteSelectedRepairsBtn.addEventListener('click', deleteSelectedRepairs);
            
            // Event listener para el selector de tamaño de página
            if (pageSizeSelect) {
                pageSizeSelect.addEventListener('change', (e) => {
                    pageSize = parseInt(e.target.value);
                    currentPage = 1; // Resetear a la primera página
                    renderTable();
                });
            }
            
            // --- FILTERING EVENTS ---\
            if (statusFilter) statusFilter.addEventListener('change', renderTable);
            if (searchInput) searchInput.addEventListener('keyup', renderTable);
            // --- INITIAL RENDERING ---
            const fullRender = () => {
                renderTable();
                renderLoanerTable();
                updateKPIs();
                renderChart();
                renderMonthlyChart();
                renderClassChart();
                renderStudentsChart();
                populateClassGroupDropdown(); // Ensure dropdown is populated on initial load
                populateSchoolYearSelect(); // Populate school year selector
                updateSortIcons();
            };
            // Load configuration and render on startup
            loadConfig();
            fullRender();
        });
    </script>
</body>
</html>